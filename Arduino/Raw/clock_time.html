<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clock Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Include iro.js CSS (optional) -->
    <!-- Include noUiSlider CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">
    <link rel="manifest" href="/manifest.json">
    <style>
        :root {
            --background-color: #292929;
            --container-bg-color: #242424;
            --text-color: #333;
            --menu-bg-color: #fff;
            --menu-text-color: #333;
            --digit-color: #000;
            --digit-colon-color: #000;
            --slider-track-bg-color: #dbdbdb;
            --slider-track-border-color: #808080;
            --slider-fill-color: #454545;
            --slider-handle-color: #1c1c1c;
            --color-picker-border-color: #ffb3b3;
            --color-picker-bg-color: #ffb3b3;
            --alarm-box-bg-color: #e0e0e0;
            --border-color: black;
            --toggle-alarm-on-bg-color: green;
            --toggle-alarm-off-bg-color: red;
            --delete-alarm-color: #dc3545;
            --button-bg-color: grey;
            --button-text-color: white;
            --button-enabled-bg-color: green;
            --item-in-modal-color: white;
            /* Add more variables for all colors used in your CSS */
        }
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: var(--container-bg-color);
            margin: 0;
            padding: 0px;
            box-sizing: border-box;
        }
        .container {
            width: 95%;
            max-width: 800px
            margin: 20px auto;
            background: var(--container-bg-color);
            padding: 20px;
            border-radius: 8px;
        }
        /* Hamburger Menu Styles */
        .menu-toggle {
            position: absolute;
            top: 30px;
            left: 30px;
            display: block;
            width: 30px;
            height: 30px;
            cursor: pointer;
            z-index: 1001;
        }
        .menu-toggle .bar {
            width: 100%;
            height: 4px;
            background-color: var(--text-color);
            margin: 5px 0;
            transition: 0.4s;
        }
        .menu {
            position: fixed;
            top: 0;
            left: -250px;
            width: 200px;
            height: 100%;
            background-color: var(--menu-bg-color);
            box-shadow: 2px 0 12px rgba(0,0,0,0.1);
            padding-top: 60px;
            transition: 0.3s;
            z-index: 1000;
        }
        .menu.open {
            left: 0;
        }
        .menu ul {
            list-style-type: none;
            padding-left: 20px;
        }
        .menu ul li {
            margin-bottom: 20px;
        }
        .menu ul li a {
            text-decoration: none;
            color: var(--text-color);
            font-size: 1.2em;
        }
        /* Main Content Styles */
        .main-content {
            margin-top: 20px;
        }
        /* Hide sections by default */
        .page {
            display: none;
        }
        /* Time Display Styles */
        #timeDisplay {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        /* Digit Styles */
        .digit {
            font-size: 8em;
            margin: 0 5px;
            color: #000;
            cursor: pointer;
        }
        .digit.colon {
            font-size: 5em;
        }
        /* Controls Section */
        .controls-section {
            display: flex;
            flex-direction: column;
        }

        /* Brightness and Color */
        .brightness-and-color {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; /* Spread items across the container */
            width: 100%; /* Ensure it takes full width */
            height: 280px;
            margin-top: 20px;
        }
        /* Brightness and Volume Control */
        .brightness-control {
            position: relative;
            left: 125px;
            bottom: 310px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-color);
        }
        .slider-label {
            margin-bottom: 10px;
            font-weight: bold;
        }
        /* Slider Containers */
        .slider-container {
            width: 50px;
            height: 200px;
            margin-bottom: 10px;
            margin-right: 10px;
        }
        /* noUiSlider Styles */
        .noUi-target {
            width: 100%;
            height: 100%;
            background: var(--slider-track-bg-color); /* Background color of the slider track */
            border: 1px solid var(--slider-track-border-color);
        }
        /* Customize the filled-in portion of the slider */
        .noUi-connect {
            background: var(--slider-fill-color); /* Color of the filled-in portion */
            border: none;
        }
        /* Customize the slider handle */
        .noUi-handle {
            background: var(--slider-handle-color); /* Color of the handle */
            border: none;
            box-shadow: none;
            border-radius: 50%;
        }

        /* Color Picker */
        #colorPickerContainer {
            position: relative;
            right: 60px;
            height: auto;
            margin-bottom: 20px;
        }
        #colorPicker {
            border: 10px solid var(--color-picker-bg-color); /* Pastel red/orange */
            border-radius: 8px;
            pointer-events: none; /* Prevent interaction initially */
            background-color: var(--color-picker-bg-color);
            opacity: 0.3;
        }
        /* Active state (pastel green) */
        #colorPicker.active {
            border-color: var(--slider-fill-color); /* Pastel green */
            background-color: var(--slider-fill-color);
            pointer-events: auto; /* Allow interaction */
            opacity: 1;
        }
        /* Alarm Controls */
        .alarm-controls {
            margin-top: 20px;
        }

        .alarm-controls h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }

        #alarm_box{
            align-items: center;
            border-radius: 5px;
            padding: 5px;
        }
        #addAlarmButton {
            position: relative;
            left: 10%;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-align: center;
            width: 80%;
        }
        .toggle-alarm.on {
            background-color: var(--toggle-alarm-on-bg-color);
            color: var(--button-text-color);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .toggle-alarm.off {
            background-color: var(--toggle-alarm-off-bg-color);
            color: var(--button-text-color);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .delete-alarm {
            background-color: transparent;
            color: #dc3545;
            font-size: 1.2em;
            cursor: pointer;
            border: none;
        }


        #alarmsList {
            list-style-type: none;
            padding: 0;
        }

        .alarm-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--container-bg-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;

        }

        .alarm-item .toggle-button {
            width: 50px;
            padding: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
        }

        .alarm-item .toggle-button.off {
            background-color: grey;
        }

        .alarm-item .toggle-button.on {
            background-color: green;
        }

        .alarm-item input[type="time"] {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px;
            font-size: 1em;
            width: 100px;
        }

        .alarm-item .delete-button {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.2em;
            cursor: pointer;
        }

        .control-row {
            display: flex;
            flex-direction: row;
            align-items: center;
            width: 100%;
            gap: 20px;
            position: relative;
            right: 10px;
        }

        /* Buttons */
        button {
            padding: 12px;
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            border: 1px solid var(--slider-fill-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
        }
        button.enabled {
            background-color: var(--slider-fill-color);
        }
        /* Inputs */
        #streamURL, #alarmTimeInput {
            padding: 10px;
            font-size: 1em;
            width: 200px;
        }
        .c-divider {
            border: none;           /* Remove the default border */
            height: 2px;            /* Set the height of the divider */
            background-color: #333; /* Set the color of the divider */
            margin: 20px 0;         /* Add spacing above and below the divider */
            width: 80%;             /* Set the width of the divider */
            margin-left: auto;      /* Center the divider horizontally */
            margin-right: auto;
        }
        .f-divider {
            position: relative;
            top: 10px;
            border: none;           /* Remove the default border */
            height: 2px;            /* Set the height of the divider */
            background-color: #333; /* Set the color of the divider */
            margin: 30px 0;         /* Add spacing above and below the divider */
            width: 80%;             /* Set the width of the divider */
            margin-left: auto;      /* Center the divider horizontally */
            margin-right: auto;
        }
        /* Styles for each station item */
        .station-item {
            position: relative; /* To position the favorite button absolutely within this container */
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--container-bg-color);
        }

        .station-item .favorite-button.favorited {
            color: #0000FF; /* Blue color when favorited */
        }
        /* Styles for the Favorite Button */
        .station-item .favorite-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none; /* Remove background */
            border: none;     /* Remove border */
            cursor: pointer;
            font-size: 1.5em;
            color: #FFD700;    /* Default star color (gold) */
            transition: color 0.3s;
        }
        .station-item h3 {
            margin: 0;
            font-size: 1.2em;
            word-wrap: break-word;
            width: 98%;
            color: var(--text-color);
        }
        .station-item p {
            margin: 5px 0;
            color: #666;
            flex-grow: 1;
            padding-right: 10px;
            word-wrap: break-word;
            width: 98%;
            color: var(--text-color);
        }
        .station-item button {
            padding: 10px;
            background-color: grey;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        /* Ensure that when the modal is open, body doesn't scroll */
        body.modal-open {
            overflow: hidden;
        }
        /* Modal Overlay */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
        }
        /* Modal Content */
        .modal-content {
            background-color: #fefefe;
            margin: 50px auto; /* 50px from top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-height: 80vh; /* Prevent the modal from exceeding viewport height */
            overflow-y: auto; /* Enable vertical scrolling within modal */
            border-radius: 8px;
            position: relative;
        }

        /* Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }


        /* Styles for Favourites and YouTube Links Menu */
        #favoritesMenu {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        #favoritesMenu button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        /* Styles for Favorites and YouTube Lists */
        .favorites-section {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--container-bg-color);
            border-radius: 5px;
        }

        .favorites-section h3 {
            margin-top: 0;
            color: var(--text-color);
        }

        .favorites-section ul {
            list-style-type: none;
            padding-left: 0;
        }

        .favorites-section li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 0;
        }

        .favorites-section li button.play-button {
            background-color: #a9bf86;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .favorites-section li button.play-button:select {
            background-color: #218838;
        }

        .favorites-section li button.favorite-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            color: #FFD700; /* Gold color for the star */
        }

        .favorites-section li button.favorite-button.favorited {
            color: #FFA500; /* Orange color when favorited */
        }
        #fav_lists{
            border: none;
            border-radius: 20px;
            padding: 10px;
            width: 93%;
        }
        /* Style for the display-controls div */
        .display-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
        }
        /* Make both buttons span equally */
        #displayModeToggle, #hourFormatToggle {
            flex-grow: 1;
            text-align: center;
        }
        /* Current Stream Section */
        .current-stream {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .current-stream #currentStreamTitle {
            flex-grow: 1;
            font-size: 1.1em;
            color: var(--text-color);
        }

        /* Favorite Button for Current Stream */
        .favorite-button {
            background: none; /* Remove background */
            border: none;     /* Remove border */
            cursor: pointer;
            font-size: 1.5em;
            color: #FFD700;    /* Default star color (gold) */
            transition: color 0.3s;
        }

        .favorite-button.favorited {
            color: #0000FF; /* Blue color when favorited */
        }

        /* Loading Screen Styles */
        #loadingScreen {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: #fff; /* or rgba(255,255,255,0.8) for opacity */
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 2000; /* Make sure it covers other elements */
        }
        /* Spinner Container inside Modal */
        .spinner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        /* Spinner inside Modal */
        .modal-spinner {
            border: 10px solid var(--text-color);
            border-top: 10px solid var(--slider-fill-color);
            border-bottom: 10px solid var(--slider-fill-color);
            border-radius: 30%;
            width: 50px;
            height: 45px;
            gap: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto; /* Center the spinner */
        }

        .spinner {
          border: 8px solid #f3f3f3; /* Light grey */
          border-top: 8px solid #3498db; /* Blue */
          border-radius: 50%;
          width: 60px;
          height: 60px;
          animation: spin 2s linear infinite;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        /* Styles for Day Buttons */
        .day-button {
            width: 80px;
            height: 80px;
            display: inline-block;
            padding: 0px;
            margin: 0px;
            background-color: var(--container-bg-color);
            color: var(--button-text-color);
            border: 1px solid var(--slider-fill-color);
            cursor: pointer;
            margin-bottom: 10px;
        }

        .day-button.selected {
            background-color: var(--slider-fill-color); /* Translucent cyan blue */
        }

        /* Style the Save button to stick to the bottom left */
        #daySelectionModal #saveDaySelectionButton {
            position: absolute;
            bottom: 20px; /* Adjust as needed for spacing */
            left: 20px;   /* Adjust as needed for spacing */
            width: auto;  /* Adjust width if necessary */
            padding: 10px 20px;
            background-color: var(button-bg-color); /* Green background */
            color: var(--button-text-color);
            border: 1px solid var(--slider-fill-color);
            border-radius: 20px;
            cursor: pointer;
        }

        /* Style adjustments for modal content */
        #daySelectionModal .modal-content {
            max-width: 500px;
            position: relative;
            padding-bottom: 70px;
            margin: 50px auto;
        }

        #daySelectionModal h3 {
            margin-top: 0;
            color: var(--text-color);
        }

        #daySelectionContainer {
            display: flex;
            justify-content: space-between;
        }
        .youtube-icon {
            width: 30px;
            height: 30px;
            background-color: #FF0000;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .youtube-icon::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 10px solid white;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }
        .radio-icon {
            display: inline-block;
            position: relative;
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        /* Center circle representing the antenna base */
        .radio-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 60%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background-color: var(--slider-handle-color);
            border-radius: 50%; /* Makes it a perfect circle */
        }

        /* Vertical line representing the antenna */
        .radio-icon::after {
            content: '';
            position: absolute;
            top: 60%;
            left: 60%;
            transform: translateX(-50%);
            width: 2px;
            height: 10px;
            background-color: var(--slider-fill-color);
        }

        /* First arc (outer) */
        .radio-arc-outer {
            position: absolute;
            top: -5px;
            left: -5px;
            width: 34px;
            height: 34px;
            border: 2px solid var(--slider-fill-color);
            border-radius: 50%;
            border-top-color: transparent;
            border-bottom-color: transparent;
        }

        /* Second arc (inner) */
        .radio-arc-inner {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            border: 2px solid var(--slider-fill-color);
            border-radius: 50%;
            border-top-color: transparent;
            border-bottom-color: transparent;
        }

        .thumbnail-container {
            flex: 0 0 120px;
            margin-right: 15px;
        }
        .youtube-item {
            display: flex;
            flex-direction: column; /* Adjust to allow better layout */
            align-items: flex-start;
            position: relative;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background-color: var(--container-bg-color);
        }
        .youtube-item .favorite-button{
            position: absolute;
            top: 0px;
            right: 5px;
            margin-left: 5px;
        }
        .youtube-item .youtube-icon {
            position: absolute;
            top: 10px;
            left: 0px;
            margin-left: 5px;
        }
        .youtube-thumbnail {
            width: 100%;
            height: auto;
            border-radius: 5px;
            margin-top: 40px;
        }

        .info-container {
            flex: 1;
        }
        /* Device Settings Page Styles */
        #deviceSettingsPage {
            background-color: var(--container-bg-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        h2.page-header {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-color);
            text-align: center;
        }

        #preferencesForm {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
            color: var(--text-color);
        }

        #preferencesForm label {
            display: flex;
            align-items: center;
            font-size: 1em;
            color: #333;
            gap: 10px;
            color: var(--text-color);
        }

        #preferencesForm input[type="checkbox"] {
            width: 20px;
            height: 20px;

        }

        #deleteSelectedGroupsButton {
            padding: 10px 20px;
            background-color: var(--button-bg-color);
            color: white;
            border: 1px solid var(--slider-fill-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            width: 135px;
        }

        #resetDeviceButton {
            padding: 10px 20px;
            background-color: var(--button-bg-color);
            color: white;
            border: 1px solid var(--slider-fill-color);
            border-radius: 20px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 1em;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-color);
        }

        .form-group label {
            font-size: 1.1em;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group select {
            padding: 8px;
            width: 60%;
            border: 1px solid var(--slider-fill-color);
            border-radius: 20px;
            color: var(--text-color);
            background-color: var(--container-bg-color);
        }
        #wifiOffStart {
            position: relative;
            right: 10px;
            background-color: var(--container-bg-color);
            color: var(--text-color);
            border: 1px solid var(--slider-fill-color);
            border-radius: 20px;
            font-size: 1.5em;
        }
        #wifiOffEnd {
            position: relative;
            right: 10px;
            background-color: var(--container-bg-color);
            color: var(--text-color);
            border: 1px solid var(--slider-fill-color);
            border-radius: 20px;
            font-size: 1.5em;
        }

        .form-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .form-actions button {
            width: 100%;
            max-width: 200px;
        }
        #searchMessage {
            opacity: 1;
            transition: opacity 0.5s;
            font-size: 1.2em;
            text-align: center;
            margin-top: 10px;
        }

        /* Auto Brightness Toggle Button Styles */
        .auto-brightness-toggle {
            padding: 10px;
            border-radius: 20px;
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            margin-right: 115px;
        }
        .lightbulb {
          width: 20px;
          height: 20px;
          background-color: #edc542;
          border-radius: 50%; /* Bulb */
          position: relative;
          box-shadow: 0 0 5px yellow;
          right: 3px;
          bottom: 5px;
          margin: 10px;

          /* Base of the bulb */
        }
        .lightbulb::after {
          content: '';
          position: absolute;
          bottom: -5px;
          left: 7px;
          width: 6px;
          height: 10px;
          background-color: grey;
          border-radius: 2px;
        }
        .volume-icon {
          position: relative;
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: start;
          bottom: 130px;
          left: 35px;
        }

        .volume-icon::before {
          content: '';
          width: 6px;
          height: 12px;
          background-color: grey;
          clip-path: polygon(0% 0%, 100% 20%, 100% 80%, 0% 100%);
          margin-right: 2px; /* Spacing between speaker and waves */
        }
        .alarm-volume-icon {
          position: relative;
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          left: 10px;
          bottom: 10px;
        }
        .alarm-volume-icon::before {
          content: '';
          width: 6px;
          height: 12px;
          background-color: grey;
          clip-path: polygon(0% 0%, 100% 20%, 100% 80%, 0% 100%);
          margin-right: 2px; /* Spacing between speaker and waves */
        }
        #alarmVolumeValue {
            position: relative;
            left: 15px;
            color: var(--text-color);
        }

        .wave {
          position: relative;
          border: 3px solid grey;
          border-radius: 30%;
          margin-left: 3px;
        }

        /* Sizes for the waves */
        .wave1 {
          width: 5px;
          height: 5px;
        }

        .wave2 {
          width: 10px;
          height: 10px;
        }

        .wave3 {
          width: 15px;
          height: 15px;
        }
        /* Volume and Stream Input Container in Modal */
        .volume-and-stream {
            display: flex;
            flex-direction: row;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
            padding: 10px;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
            color: var(--text-color);
        }

        /* Adjust volume-control for the modal */
        #daySelectionModal .volume-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 15%;
        }

        /* Adjust the size of the slider-container in the modal */
        #daySelectionModal .slider-container {
            width: 50px;
            height: 200px;
            margin-bottom: 10px;
        }

        /* Adjust the volume-icon for the modal */
        #daySelectionModal .volume-icon {
            margin-bottom: 10px;
        }

        /* Style the stream-input in the modal */
        #daySelectionModal .stream-input {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            width: 80%;
            border-radius: 5px;
            background-color: var(--container-bg-color);
        }

        /* Adjust the stream URL input field */
        #daySelectionModal #alarmStreamURL {
            position: relative;
            width: 97%;
            padding: 8px;
            box-sizing: border-box;
            margin: 5px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--container-bg-color);
            color: var(--text-color);
        }

        /* Style the loading indicator and search results */
        #daySelectionModal #alarmSearchResults {
            position: relative;
            width: 97%;
            box-sizing: border-box;
            overflow-x: hidden;
            overflow-y: auto;
            max-height: 300px;
            margin: 5px;
            border-radius: 5px;
        }
        /* Adjust titles and descriptions */
        #daySelectionModal .station-item h3,
        #daySelectionModal .youtube-item h3 {
            word-wrap: break-word;
            overflow-wrap: break-word;
            margin: 0 0 5px 0;
            font-size: 1em;
            color: var(--text-color);
        }

        #daySelectionModal .station-item p,
        #daySelectionModal .youtube-item p {
            word-wrap: break-word;
            overflow-wrap: break-word;
            margin: 5px 0;
            font-size: 0.9em;
        }

        /* Ensure images and thumbnails fit within the container */
        #daySelectionModal .thumbnail-container,
        #daySelectionModal .youtube-thumbnail {
            max-width: 100%;
            height: auto;
        }

        /* Adjust play and set buttons */
        #daySelectionModal .set-alarm-button {
            padding: 8px 12px;
            margin-top: 10px;
            border: none;
            cursor: pointer;
        }

        /* Style for each search result item */
        #daySelectionModal .station-item,
        #daySelectionModal .youtube-item {
            display: flex;
            flex-direction: column; /* Stack content vertically */
            width: 100%; /* Ensure it takes full width */
            box-sizing: border-box;
            word-wrap: break-word; /* Break long words */
            overflow-wrap: break-word; /* Break long words */
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--container-bg-color);
        }

        /* Loading Indicator */
        .loading-indicator {
            text-align: center;
            font-size: 16px;
            color: var(--slider-fill-color);
            margin-top: 10px;
        }
        /* Styles for Disable Zero Options */
        #disableZeroOptions h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }

        #disableZeroOptions label {
            display: block;
            margin-bottom: 0px;
            font-size: 1em;
        }
        #confirmDigitColorButton {
            position: relative;
            top: 10px;
            width: 100px;
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
        }
        #streamURL {
            position: relative;
            bottom: 140px;
            width: 300px;
            padding: 10px;
            box-sizing: border-box; /* Include padding in width calculation */
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--container-bg-color);
            color: var(--text-color);
            font-size: 1em;
        }
        .controls {
            margin-top: 80px;
            padding: 15px;
            display: flex;
            flex-direction: row;
            gap: 30px;
            position: relative;
            right: 320px;
        }
        .url-container {
            display: flex;
            padding: 10px;
            width: 100%;
            position: relative;
            left: 40px;

        }
        #audioStreamToggle {
            position: relative;
            height: 200px;
            width: 200px;
            border-radius: 50px;
            padding:
        }
        #volumeValue {
            position: relative;
            top: 110px;
            right: 48px;
        }
        #brightnessValue {
            position: relative;
            right: 3px;
        }
        #currently_playing {
            color: var(--text-color);
        }
        #themeSwitchButton {
            position: relative;
            margin-top: 50px;
        }
        #timeZoneSelect {
            height: 30px;
        }








        /* Responsive adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: var(--container-bg-color);
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            color: var(--menu-text-color);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Page Sections */
        .page.active {
            display: block;
        }
        .page-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
            width: 100%;
            height: 30px;
            padding: 10px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--slider-fill-color);
            background-color: var(--container-bg-color);
        }
        .form-group input[type="checkbox"] {
            margin-right: 5px;
        }
        .form-actions {
            text-align: center;
        }
        .form-actions button {
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
                console.log('Service Worker registered with scope:', registration.scope);
            }).catch((error) => {
                console.log('Service Worker registration failed:', error);
            });
        }
    </script>
    <!-- Firmware Update Checker Script -->
    <script>
        window.addEventListener('load', function() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            // Check for firmware updates
            fetch('/getFirmwareStatus')
                .then(response => response.json())
                .then(data => {
                    if (data.updateAvailable) {
                        if (confirm('A new firmware update is available. Would you like to update now?')) {
                            // Trigger the firmware update
                            fetch('/updateFirmware', { method: 'POST' })
                                .then(response => {
                                    alert('Firmware update initiated. The device will restart.');
                                })
                                .catch(error => {
                                    alert('Failed to initiate firmware update.');
                                });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching firmware status:', error);
                });
        });
    </script>
    <!-- Hamburger Menu -->
    <div class="menu-toggle" id="menuToggle">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>
    <!-- Sidebar Menu -->
    <nav class="menu" id="menu">
        <ul>
            <li><a href="#" data-page="main">Main</a></li>
            <li><a href="#" data-page="timezone">Set Time Zone</a></li>
            <li><a href="#" data-page="wifi">Wi-Fi Settings</a></li>
            <li><a href="#" data-page="deviceSettings">Device Settings</a></li>
        </ul>
    </nav>
    <div class="container">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Main Page -->
            <div id="mainPage" class="page active">
                <button id="themeSwitchButton">Switch Theme</button>

                <!-- Time Display -->
                <div id="timeDisplay">
                    <!-- Digit spans will go here -->
                </div>
                <hr class="c-divider">
                <!-- Display Mode Toggle Button -->
                <!-- Display Mode and 12/24 Hour Toggle Buttons -->
                <div class="display-controls">
                    <button id="displayModeToggle">Display Mode: Time</button>
                    <button id="hourFormatToggle">12 Hour Format</button>
                </div>
                <!-- Controls Section -->
                <div class="controls-section">
                    <!-- Color and Brightness -->
                    <div class="brightness-and-color">
                        <!-- Color Picker -->
                        <div id="colorPickerContainer">
                            <div id="colorPicker"></div>
                        </div>
                        <div><button class="auto-brightness-toggle" id="autoBrightnessToggle">Turn Off Auto Brightness</button></div>
                        <!-- Brightness Control -->
                        <div class="brightness-control">
                            <div class="lightbulb"></div>
                            <div class="slider-container">
                                <div id="brightnessSlider"></div>
                            </div>
                            <span id="brightnessValue">128</span>
                        </div>
                    </div>
                    <hr class="f-divider">
                    <!-- Audio and Alarm Controls -->
                    <div class="audio-alarm-controls">
                        <!-- Audio Stream Control -->
                        <div class="control-row">
                        <!-- Stream URL Input -->
                            <div class="url-container">
                                <input type="text" id="streamURL" name="streamURL" placeholder="Search...">
                            </div>
                            <!-- Controls Row -->
                            <div class="controls">
                                <button id="audioStreamToggle">Audio Stream Off</button>
                                <div class="volume-control">
                                    <div class="volume-icon">
                                        <div class="wave wave1"></div>
                                        <div class="wave wave2"></div>
                                        <div class="wave wave3"></div>
                                    </div>
                                    <div class="slider-container">
                                        <div id="volumeSlider"></div>
                                    </div>
                                    <span id="volumeValue">10</span>
                                </div>
                            </div>
                        </div>

                        <div id="statusMessage" style="margin-top: 10px; text-align: center; display: none;"></div>
                        <hr class="c-divider">
                        <!-- Current Stream Title and Favorite Button -->
                        <h3 id="currently_playing">Currently Playing</h3>
                        <div class="current-stream">
                            <span id="currentStreamTitle">No stream playing</span>
                        </div>
                        <hr class="c-divider">
                        <section id="fav_lists">
                            <!-- Favourites Menu -->
                            <div class="control-row" id="favoritesMenu">
                                <button id="favouritesButton">Favourites</button>
                            </div>
                            <!-- Lists for Favourites and YouTube Links -->
                            <div id="favouritesList" class="favorites-section" style="display: none;">
                                <h3>Favourites</h3>
                                <ul id="favouritesUl">
                                    <!-- Favourited stations will be populated here -->
                                </ul>
                            </div>
                        </section>
                        <hr class="c-divider">
                        <section id="alarm_box">
                            <!-- Alarm Controls -->
                            <div class="audio-alarm-controls">
                                <!-- Alarms List -->
                                <ul id="alarmsList">
                                    <!-- Additional alarms will be added here dynamically -->
                                </ul>
                                <!-- Add Alarm Button -->
                                <button id="addAlarmButton" style="margin-bottom: 10px;">+ Add Alarm</button>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            <!-- Time Zone Page -->
            <div id="timezonePage" class="page">
                <h2 class="page-header">Set Time Zone</h2>
                <div class="form-group">
                    <label for="timezoneSelect">Time Zone:</label>
                    <select id="timezoneSelect">
                        <!-- Time zones will be populated here -->
                    </select>
                </div>
                <div class="form-actions">
                    <button id="saveTimezoneButton">Save Time Zone</button>
                </div>
            </div>
            <!-- Wi-Fi Settings Page -->
            <div id="wifiPage" class="page">
                <h2 class="page-header">Wi-Fi Settings</h2>
                <div class="form-group">
                    <label>Device IP Address:</label>
                    <span id="deviceIPAddress">Fetching...</span>
                </div>
                <div class="form-group">
                    <label for="ssidInput">Wi-Fi Name (SSID):</label>
                    <input type="text" id="ssidInput" name="ssid">
                </div>
                <div class="form-group">
                    <label for="passwordInput">Wi-Fi Password:</label>
                    <input type="password" id="passwordInput" name="password">
                </div>
                <div class="form-group">
                    <input type="checkbox" id="wifiOffCheckbox">
                    <label for="wifiOffCheckbox">Enable Wi-Fi Off Schedule</label>
                </div>
                <div class="form-group">
                    <label for="wifiOffStart">Wi-Fi Off Start Time:</label>
                    <input type="time" id="wifiOffStart" name="wifiOffStart">
                </div>
                <div class="form-group">
                    <label for="wifiOffEnd">Wi-Fi Off End Time:</label>
                    <input type="time" id="wifiOffEnd" name="wifiOffEnd">
                </div>
                <div class="form-actions">
                    <button id="saveWiFiSettingsButton">Save Wi-Fi Settings</button>
                </div>
            </div>
            <!-- Device Settings Page -->
            <div id="deviceSettingsPage" class="page">
                <h2 class="page-header">Device Settings</h2>
                <form id="preferencesForm">
                    <h3>Select Groups to Delete:</h3>

                    <!-- Display Settings Group -->
                    <label>
                        <input type="checkbox" name="preferenceGroups" value="displaySettings">
                        Display Settings
                    </label><br>

                    <!-- Audio Settings Group -->
                    <label>
                        <input type="checkbox" name="preferenceGroups" value="audioSettings">
                        Audio Settings
                    </label><br>

                    <!-- Time Settings Group -->
                    <label>
                        <input type="checkbox" name="preferenceGroups" value="timeSettings">
                        Time Settings
                    </label><br>

                    <!-- Wi-Fi Settings Group -->
                    <label>
                        <input type="checkbox" name="preferenceGroups" value="wifiSettings">
                        Wi-Fi Settings
                    </label><br>

                    <!-- Alarms Group -->
                    <label>
                        <input type="checkbox" name="preferenceGroups" value="alarms">
                        Alarms
                    </label><br>

                    <!-- Brightness Mappings Group -->
                    <label>
                        <input type="checkbox" name="preferenceGroups" value="brightnessMappings">
                        Brightness Mappings
                    </label><br>

                    <!-- Submit Button -->
                    <button type="button" id="deleteSelectedGroupsButton">Delete</button>
                </form>
                <!-- Existing Reset Device Button -->
                <div class="form-group">
                    <button id="resetDeviceButton">Reset Device</button>
                </div>
            </div>

        </div>
        <!-- Modal for Digit Color Picker -->
        <div id="digitColorPickerModal" class="modal">
            <div class="modal-content">
                <span id="closeDigitColorPicker" class="close">&times;</span>
                <label for="digitColorPicker">Select Color for Digit/Colon:</label>
                <div id="digitColorPicker"></div>

                <!-- Checkboxes for disabling zero on specific modes -->
                <div id="disableZeroOptions" style="display: none; margin-top: 15px;">
                    <h3>Disable Zero Options:</h3>
                    <label>
                        <input type="checkbox" id="disableZero24hr">
                        Disable 0 on 24-hour format
                    </label><br>
                    <label>
                        <input type="checkbox" id="disableZero12hr">
                        Disable 0 on 12-hour format
                    </label><br>
                    <label>
                        <input type="checkbox" id="disableZeroCountdown">
                        Disable 0 on Countdown
                    </label>
                </div>

                <button id="confirmDigitColorButton">OK</button>
            </div>
        </div>
    </div>
    <!-- Modal for Station List -->
    <div id="stationListModal" class="modal">
        <div class="modal-content">
            <span id="closeStationListModal" class="close">&times;</span>
            <h2>Search Results</h2>
            <div id="stationList"></div>
        </div>
    </div>
    <!-- Modal for Day Selection -->
    <div id="daySelectionModal" class="modal">
        <div class="modal-content">
            <span id="closeDaySelectionModal" class="close">&times;</span>
            <h2>Set Alarm Details</h2>
            <!-- Day Selection -->
            <div id="daySelectionContainer"></div>

            <!-- Volume and Stream URL Container -->
            <div class="volume-and-stream">
                <!-- Volume Control -->
                <div class="alarm-volume-control">
                    <div class="alarm-volume-icon">
                        <div class="wave wave1"></div>
                        <div class="wave wave2"></div>
                        <div class="wave wave3"></div>
                    </div>
                    <div class="slider-container">
                        <div id="alarmVolumeSlider"></div>
                    </div>
                    <span id="alarmVolumeValue">10</span>
                </div>

                <!-- Stream URL Input and Search Results -->
                <div class="stream-input">
                    <input type="text" id="alarmStreamURL" placeholder="Search...">

                    <!-- Loading Indicator -->
                    <div id="alarmLoadingIndicator" class="loading-indicator" style="display: none;">
                        Searching...
                    </div>

                    <!-- Search Results Container -->
                    <div id="alarmSearchResults"></div>
                </div>
            </div>

            <!-- Save Button -->
            <button id="saveDaySelectionButton">Save</button>
        </div>
    </div>

    <!-- Include iro.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <!-- Include noUiSlider JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
    <script>
        // Define the themes
        const themes = [
            {
                name: 'Elegant',
                properties: {
                    '--background-color': '#f5f5f5',
                    '--container-bg-color': '#ffffff',
                    '--text-color': '#333333',
                    '--menu-bg-color': '#e0e0e0',
                    '--menu-text-color': '#333333',
                    '--digit-color': '#000000',
                    '--digit-colon-color': '#000000',
                    '--slider-track-bg-color': '#cccccc',
                    '--slider-track-border-color': '#999999',
                    '--slider-fill-color': '#666666',
                    '--slider-handle-color': '#333333',
                    '--color-picker-border-color': '#999999',
                    '--color-picker-bg-color': '#cccccc',
                    '--alarm-box-bg-color': '#e0e0e0',
                    '--border-color': '#999999',
                    '--toggle-alarm-on-bg-color': '#008000',
                    '--toggle-alarm-off-bg-color': '#ff0000',
                    '--delete-alarm-color': '#dc3545',
                    '--button-bg-color': '#333333',
                    '--button-text-color': '#ffffff',
                    '--button-enabled-bg-color': '#008000',
                }
            },
            {
                name: 'Dark Theme',
                properties: {
                    '--background-color': '#121212',
                    '--container-bg-color': '#1f1f1f',
                    '--text-color': '#e0e0e0',
                    '--menu-bg-color': '#2a2a2a',
                    '--menu-text-color': '#e0e0e0',
                    '--digit-color': '#ffffff',
                    '--digit-colon-color': '#ffffff',
                    '--slider-track-bg-color': '#444444',
                    '--slider-track-border-color': '#888888',
                    '--slider-fill-color': '#666666',
                    '--slider-handle-color': '#999999',
                    '--color-picker-border-color': '#888888',
                    '--color-picker-bg-color': '#444444',
                    '--alarm-box-bg-color': '#333333',
                    '--border-color': '#444444',
                    '--toggle-alarm-on-bg-color': '#00ff00',
                    '--toggle-alarm-off-bg-color': '#ff0000',
                    '--delete-alarm-color': '#e00000',
                    '--button-bg-color': '#555555',
                    '--button-text-color': '#e0e0e0',
                    '--button-enabled-bg-color': '#00aa00',
                }
            },
            {
                name: 'Calm Pastel',
                properties: {
                    '--background-color': '#f2f0f7',
                    '--container-bg-color': '#ffffff',
                    '--text-color': '#5c5c8a',
                    '--menu-bg-color': '#e6e6fa',
                    '--menu-text-color': '#5c5c8a',
                    '--digit-color': '#5c5c8a',
                    '--digit-colon-color': '#5c5c8a',
                    '--slider-track-bg-color': '#dcdcdc',
                    '--slider-track-border-color': '#c0c0c0',
                    '--slider-fill-color': '#c0c0c0',
                    '--slider-handle-color': '#a0a0a0',
                    '--color-picker-border-color': '#c0c0c0',
                    '--color-picker-bg-color': '#dcdcdc',
                    '--alarm-box-bg-color': '#f5f5f5',
                    '--border-color': '#c0c0c0',
                    '--toggle-alarm-on-bg-color': '#90ee90',
                    '--toggle-alarm-off-bg-color': '#ffcccb',
                    '--delete-alarm-color': '#ff6b6b',
                    '--button-bg-color': '#dcdcdc',
                    '--button-text-color': '#5c5c8a',
                    '--button-enabled-bg-color': '#90ee90',
                }
            },
            {
                name: 'Cyberpunk',
                properties: {
                    '--background-color': '#000000',
                    '--container-bg-color': '#1a1a1a',
                    '--text-color': '#00ffff',
                    '--menu-bg-color': '#1a1a1a',
                    '--menu-text-color': '#ff00ff',
                    '--digit-color': '#ff00ff',
                    '--digit-colon-color': '#00ffff',
                    '--slider-track-bg-color': '#333333',
                    '--slider-track-border-color': '#666666',
                    '--slider-fill-color': '#ff00ff',
                    '--slider-handle-color': '#00ffff',
                    '--color-picker-border-color': '#ff00ff',
                    '--color-picker-bg-color': '#333333',
                    '--alarm-box-bg-color': '#1a1a1a',
                    '--border-color': '#ff00ff',
                    '--toggle-alarm-on-bg-color': '#00ff00',
                    '--toggle-alarm-off-bg-color': '#ff0000',
                    '--delete-alarm-color': '#ff0000',
                    '--button-bg-color': '#1a1a1a',
                    '--button-text-color': '#00ffff',
                    '--button-enabled-bg-color': '#ff00ff',
                }
            },
            {
                name: 'Retro',
                properties: {
                    '--background-color': '#f4ecd8',
                    '--container-bg-color': '#fff1c1',
                    '--text-color': '#333333',
                    '--menu-bg-color': '#ffcc00',
                    '--menu-text-color': '#333333',
                    '--digit-color': '#333333',
                    '--digit-colon-color': '#333333',
                    '--slider-track-bg-color': '#ffcc00',
                    '--slider-track-border-color': '#cc9900',
                    '--slider-fill-color': '#cc9900',
                    '--slider-handle-color': '#996600',
                    '--color-picker-border-color': '#cc9900',
                    '--color-picker-bg-color': '#ffcc00',
                    '--alarm-box-bg-color': '#fff1c1',
                    '--border-color': '#cc9900',
                    '--toggle-alarm-on-bg-color': '#008000',
                    '--toggle-alarm-off-bg-color': '#ff0000',
                    '--delete-alarm-color': '#dc3545',
                    '--button-bg-color': '#ffcc00',
                    '--button-text-color': '#333333',
                    '--button-enabled-bg-color': '#cc9900',
                }
            },
            {
                name: 'Muted Earth',
                properties: {
                    '--background-color': '#eae7dc',
                    '--container-bg-color': '#d8c3a5',
                    '--text-color': '#8e8d8a',
                    '--menu-bg-color': '#e98074',
                    '--menu-text-color': '#8e8d8a',
                    '--digit-color': '#8e8d8a',
                    '--digit-colon-color': '#8e8d8a',
                    '--slider-track-bg-color': '#d8c3a5',
                    '--slider-track-border-color': '#8e8d8a',
                    '--slider-fill-color': '#8e8d8a',
                    '--slider-handle-color': '#e98074',
                    '--color-picker-border-color': '#8e8d8a',
                    '--color-picker-bg-color': '#eae7dc',
                    '--alarm-box-bg-color': '#d8c3a5',
                    '--border-color': '#8e8d8a',
                    '--toggle-alarm-on-bg-color': '#008000',
                    '--toggle-alarm-off-bg-color': '#ff0000',
                    '--delete-alarm-color': '#e98074',
                    '--button-bg-color': '#e98074',
                    '--button-text-color': '#ffffff',
                    '--button-enabled-bg-color': '#e85a4f',
                }
            },
            {
                name: 'Winter Frost',
                properties: {
                    '--background-color': '#f0f8ff',
                    '--container-bg-color': '#e0f7fa',
                    '--text-color': '#006064',
                    '--menu-bg-color': '#b2ebf2',
                    '--menu-text-color': '#006064',
                    '--digit-color': '#006064',
                    '--digit-colon-color': '#006064',
                    '--slider-track-bg-color': '#b2ebf2',
                    '--slider-track-border-color': '#4dd0e1',
                    '--slider-fill-color': '#4dd0e1',
                    '--slider-handle-color': '#00bcd4',
                    '--color-picker-border-color': '#4dd0e1',
                    '--color-picker-bg-color': '#b2ebf2',
                    '--alarm-box-bg-color': '#e0f7fa',
                    '--border-color': '#4dd0e1',
                    '--toggle-alarm-on-bg-color': '#00ff00',
                    '--toggle-alarm-off-bg-color': '#ff0000',
                    '--delete-alarm-color': '#e57373',
                    '--button-bg-color': '#4dd0e1',
                    '--button-text-color': '#ffffff',
                    '--button-enabled-bg-color': '#00acc1',
                }
            },
            {
                name: 'Autumn Leaves',
                properties: {
                    '--background-color': '#fff8e1',
                    '--container-bg-color': '#ffe0b2',
                    '--text-color': '#6d4c41',
                    '--menu-bg-color': '#ffcc80',
                    '--menu-text-color': '#6d4c41',
                    '--digit-color': '#6d4c41',
                    '--digit-colon-color': '#6d4c41',
                    '--slider-track-bg-color': '#ffb74d',
                    '--slider-track-border-color': '#ef6c00',
                    '--slider-fill-color': '#ef6c00',
                    '--slider-handle-color': '#e65100',
                    '--color-picker-border-color': '#ef6c00',
                    '--color-picker-bg-color': '#ffcc80',
                    '--alarm-box-bg-color': '#ffe0b2',
                    '--border-color': '#ef6c00',
                    '--toggle-alarm-on-bg-color': '#8bc34a',
                    '--toggle-alarm-off-bg-color': '#f44336',
                    '--delete-alarm-color': '#d84315',
                    '--button-bg-color': '#ef6c00',
                    '--button-text-color': '#ffffff',
                    '--button-enabled-bg-color': '#e65100',
                }
            },
            {
                name: 'Candy Pop',
                properties: {
                    '--background-color': '#ffe4e1',
                    '--container-bg-color': '#ffb6c1',
                    '--text-color': '#ff1493',
                    '--menu-bg-color': '#ff69b4',
                    '--menu-text-color': '#ffffff',
                    '--digit-color': '#ff1493',
                    '--digit-colon-color': '#ff69b4',
                    '--slider-track-bg-color': '#ffb6c1',
                    '--slider-track-border-color': '#ff69b4',
                    '--slider-fill-color': '#ff69b4',
                    '--slider-handle-color': '#ff1493',
                    '--color-picker-border-color': '#ff69b4',
                    '--color-picker-bg-color': '#ffb6c1',
                    '--alarm-box-bg-color': '#ffb6c1',
                    '--border-color': '#ff69b4',
                    '--toggle-alarm-on-bg-color': '#00ff00',
                    '--toggle-alarm-off-bg-color': '#ff0000',
                    '--delete-alarm-color': '#ff1493',
                    '--button-bg-color': '#ff69b4',
                    '--button-text-color': '#ffffff',
                    '--button-enabled-bg-color': '#ff1493',
                }
            },
            {
                name: 'Espresso',
                properties: {
                    '--background-color': '#3e2723',
                    '--container-bg-color': '#5d4037',
                    '--text-color': '#d7ccc8',
                    '--menu-bg-color': '#4e342e',
                    '--menu-text-color': '#d7ccc8',
                    '--digit-color': '#ffffff',
                    '--digit-colon-color': '#ffffff',
                    '--slider-track-bg-color': '#6d4c41',
                    '--slider-track-border-color': '#8d6e63',
                    '--slider-fill-color': '#8d6e63',
                    '--slider-handle-color': '#a1887f',
                    '--color-picker-border-color': '#8d6e63',
                    '--color-picker-bg-color': '#6d4c41',
                    '--alarm-box-bg-color': '#5d4037',
                    '--border-color': '#8d6e63',
                    '--toggle-alarm-on-bg-color': '#8bc34a',
                    '--toggle-alarm-off-bg-color': '#f44336',
                    '--delete-alarm-color': '#d84315',
                    '--button-bg-color': '#4e342e',
                    '--button-text-color': '#d7ccc8',
                    '--button-enabled-bg-color': '#8d6e63',
                }
            }
        ];
        
        let currentThemeIndex = 0;
        // JavaScript Variables
        let is24HourFormat = true;
        // Initial auto brightness state
        let autoBrightnessEnabled = true;
        let selectedAlarmIndex = null;
        let debounce_time = 25;
        let displayMode = 'time';  // Default display mode
        let brightness = 128; // Default brightness
        let color = '#008000'; // Default color in HEX (green)
        let digitColors = []; // Array for digit colors
        let colonColor = null; // Color for the colon
        let selectedElement = null; // Object to store selected element { type: 'digit'/'colon', index: number }
        // New variables for audio and alarm settings
        let volume = 10;
        let alarms = []; // Array to store multiple alarms
        let isStreaming = false;
        let streamURL = ''; // Added streamURL variable
        let currentStreamTitle = 'No stream playing';
        // Variables to store the last fetched time
        let lastHours = 0;
        let lastMinutes = 0;
        // Flag to prevent triggering events during initialization
        let isInitializing = false;
        // Variable for device IP address
        let deviceIPAddress = '';
        // Variable for Wi-Fi settings
        let enableWiFiOff = false;
        let wifiOffStartTime = '';
        let wifiOffEndTime = '';
        let timeZoneString = 'UTC0'; // Default time zone
        let alarmSearchEnabled = true;
        let mainSearchEnabled = true;
        let disableZeroSettings = {
            disable24hr: false,
            disable12hr: false,
            disableCountdown: false
        };
        const MAX_ALARMS = 10;
        
        // New Variables for Favourites
        let favourites = []; // Array to store favourited streams
        
        // Hamburger Menu Toggle
        const menuToggle = document.getElementById('menuToggle');
        const menu = document.getElementById('menu');
        
        // Declare the stationListModal and stationList elements
        const stationListModal = document.getElementById('stationListModal');
        const stationList = document.getElementById('stationList');
        
        // Declare the favouritesList and YouTubeLinksList elements
        const favouritesList = document.getElementById('favouritesList');
        const favouritesUl = document.getElementById('favouritesUl');
        const youtubeLinksUl = document.getElementById('youtubeLinksUl');
        
        // Favourites and YouTube Links Buttons
        const favouritesButton = document.getElementById('favouritesButton');
        
        // Elements
        const currentStreamTitleElement = document.getElementById('currentStreamTitle');
        
        menuToggle.addEventListener('click', function() {
            menu.classList.toggle('open');
        });
        function applyTheme(theme) {
            const root = document.documentElement;
            const properties = theme.properties;
            for (let property in properties) {
                root.style.setProperty(property, properties[property]);
            }
        }
        
        document.getElementById('themeSwitchButton').addEventListener('click', switchTheme);
        function switchTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            applyTheme(themes[currentThemeIndex]);
            // Save the current theme index to localStorage
            localStorage.setItem('currentThemeIndex', currentThemeIndex);
        }
        
        
        
        // Navigation Handling
        const menuLinks = document.querySelectorAll('.menu ul li a');
        menuLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.getAttribute('data-page');
                navigateToPage(page);
                menu.classList.remove('open');
            });
        });
        // Function to update the button text based on the current state
        function updateAutoBrightnessButton() {
            const autoBrightnessToggle = document.getElementById('autoBrightnessToggle');
            autoBrightnessToggle.textContent = autoBrightnessEnabled ? 'Turn Off Auto Brightness' : 'Turn On Auto Brightness';
        }
        
        // Event listener for the auto brightness toggle button
        document.getElementById('autoBrightnessToggle').addEventListener('click', function() {
            autoBrightnessEnabled = !autoBrightnessEnabled;
            updateAutoBrightnessButton();
        
            // Send the new state to the server
            fetch('/setAutoBrightness', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ autoBrightnessEnabled: autoBrightnessEnabled })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Auto brightness state updated on server:', data);
            })
            .catch(error => {
                console.error('Error updating auto brightness state:', error);
            });
        });
        
        // Fetch the current auto brightness state on page load
        function fetchAutoBrightnessState() {
            fetch('/getAutoBrightness')
                .then(response => response.json())
                .then(data => {
                    autoBrightnessEnabled = data.autoBrightnessEnabled;
                    updateAutoBrightnessButton();
                })
                .catch(error => {
                    console.error('Error fetching auto brightness state:', error);
                });
        }
        // Event listener for Delete Selected Groups button
        document.getElementById('deleteSelectedGroupsButton').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('input[name="preferenceGroups"]:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one group to delete.');
                return;
            }
            if (confirm('Are you sure you want to delete the selected groups?')) {
                // Collect selected groups
                const selectedGroups = Array.from(checkboxes).map(cb => cb.value);
                // Send to ESP32
                fetch('/deletePreferenceGroups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ groups: selectedGroups })
                })
                .then(response => response.json())
                .then(data => {
                    alert('Selected groups deleted.');
                    // Optionally, refresh settings or reload the page
                })
                .catch(error => {
                    console.error('Error deleting groups:', error);
                    alert('Error deleting groups.');
                });
            }
        });
        
        // Event listener for Reset Device button
        document.getElementById('resetDeviceButton').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset the device? This will erase all settings including Wi-Fi credentials.')) {
                fetch('/resetDevice', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert('Device reset. It will restart now.');
                })
                .catch(error => {
                    console.error('Error resetting device:', error);
                    alert('Error resetting device.');
                });
            }
        });
        function navigateToPage(page) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(p => p.classList.remove('active'));
            if (page === 'main') {
                document.getElementById('mainPage').classList.add('active');
            } else if (page === 'timezone') {
                document.getElementById('timezonePage').classList.add('active');
                loadTimeZoneSettings();
            } else if (page === 'wifi') {
                document.getElementById('wifiPage').classList.add('active');
                loadWiFiSettings();
            } else if (page === 'deviceSettings') {
                document.getElementById('deviceSettingsPage').classList.add('active');
            }
        }
        // Function to open the modal
        function openModal(modal) {
            modal.style.display = 'block';
            document.body.classList.add('modal-open'); // Prevent background scrolling
        }
        
        // Function to close the modal
        function closeModal(modal) {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open'); // Re-enable background scrolling
            // Reset search enabled flags
            if (modal === stationListModal) {
                mainSearchEnabled = true;
            }
            if (modal === daySelectionModal) {
                alarmSearchEnabled = true;
            }
        }
        
        // Function to update the current stream title
        function updateCurrentStreamTitle(title) {
            currentStreamTitle = title || 'No stream playing';
            currentStreamTitleElement.textContent = currentStreamTitle;
        }
        
        // Function to check if the current stream is already favorited
        function isCurrentStreamFavorited() {
            return favourites.some(fav => fav.url === streamURL);
        }
        // Favourites Menu Event Listeners
        favouritesButton.addEventListener('click', function() {
            // Toggle visibility of favourites and hide YouTube links
            if (favouritesList.style.display === 'none') {
                favouritesList.style.display = 'block';
                loadFavourites();
            } else {
                favouritesList.style.display = 'none';
            }
        });
        // Function to remove a favourite by URL
        function removeFavouriteByURL(url) {
            const index = favourites.findIndex(fav => fav.url === url);
            if (index !== -1) {
                favourites.splice(index, 1);
                // Save updated favourites to local storage
                localStorage.setItem('favourites', JSON.stringify(favourites));
                populateFavouritesList();
            }
        }
        // Function to load favourites from local storage
        // Load favourites from local storage
        function loadFavourites() {
            const storedFavourites = localStorage.getItem('favourites');
            if (storedFavourites) {
                favourites = JSON.parse(storedFavourites);
                // Ensure each favourite has a 'type' field
                favourites.forEach(fav => {
                    if (!fav.type) {
                        fav.type = isYouTubeURL(fav.url) ? 'youtube' : 'radio';
                    }
                });
            } else {
                favourites = [];
            }
            populateFavouritesList();
        }
        
        // Function to populate the favourites list in the UI
        function populateFavouritesList() {
            favouritesUl.innerHTML = ''; // Clear existing list
            if (favourites.length === 0) {
                const noFavourites = document.createElement('p');
                noFavourites.textContent = 'No favourites added yet.';
                favouritesUl.appendChild(noFavourites);
                return;
            }
            function playFavourite(fav) {
                if (fav.type === 'youtube') {
                    const encodedURL = encodeURIComponent(fav.url);
                    const fullStreamURL = `http://vahub.ca/stream_youtube?url=${encodedURL}&user=${Date.now()}`;
                    playStream(fullStreamURL, fav.name);
                } else if (fav.type === 'radio') {
                    playStream(fav.url, fav.name);
                }
            }
        
            favourites.forEach((fav, index) => {
                const li = document.createElement('li');
                li.style.borderTop = '1px solid var(--border-color)';
        
                // Play Button
                const playButton = document.createElement('button');
                playButton.className = 'play-button';
                playButton.textContent = 'Play';
                playButton.style.backgroundColor = 'var(--button-bg-color)';
                playButton.style.borderRadius = '20px';
                playButton.style.color = 'var(--button-text-color)';
                playButton.style.border = '1px solid var(--slider-fill-color)';
        
                playButton.addEventListener('click', () => {
                    playFavourite(fav);
                });
        
                // Favorite Name
                const favName = document.createElement('span');
                favName.style.paddingLeft = '10px';
                favName.textContent = fav.name || fav.url;
                favName.style.color = 'var(--text-color)';
        
                // Remove Favorite Button
                const removeButton = document.createElement('button');
                removeButton.className = 'favorite-button';
                removeButton.innerHTML = '&#9733;'; // Star icon
                removeButton.title = 'Remove from Favourites';
                removeButton.addEventListener('click', () => {
                    removeFavourite(index);
                });
        
                li.appendChild(playButton);
                li.appendChild(favName);
        
                // If the favorite is a YouTube video, display the thumbnail
                if (fav.type === 'youtube' && fav.thumbnail) {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = fav.thumbnail;
                    thumbnail.alt = `${fav.name} Thumbnail`;
                    thumbnail.style.width = '50px';
                    thumbnail.style.height = 'auto';
                    thumbnail.style.marginLeft = '10px';
                    li.appendChild(thumbnail);
                }
        
                li.appendChild(removeButton);
                favouritesUl.appendChild(li);
            });
        }
        
        
        // Function to play a stream
        function playStream(url, name = 'Streaming') {
            // Update the streamURL input field with the selected stream's URL
            document.getElementById('streamURL').value = '';
            // Update the current stream title
            updateCurrentStreamTitle(name || url);
            // Update global variables
            streamURL = url;
            streamName = name;
            // Send both the stream URL and name to the ESP
            sendStreamDataToESP(url, name);
            // Trigger the stream toggle to turn on streaming if not already streaming
            if (!isStreaming) {
                document.getElementById('audioStreamToggle').click();
            }
        }
        
        // Function to remove a favourite
        function removeFavourite(index) {
            if (index >= 0 && index < favourites.length) {
                favourites.splice(index, 1);
                // Save updated favourites to local storage
                localStorage.setItem('favourites', JSON.stringify(favourites));
                populateFavouritesList();
            }
        }
        // Handle click event for displayModeToggle
        document.getElementById('displayModeToggle').addEventListener('click', function() {
            // Toggle display mode between 'time' and 'countdown'
            displayMode = (displayMode === 'time') ? 'countdown' : 'time';
            this.textContent = 'Display Mode: ' + displayMode.charAt(0).toUpperCase() + displayMode.slice(1);
            // Send the display mode to the server
            fetch('/setDisplayMode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: displayMode })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Display mode saved on server:', data);
                fetchTime(); // Refresh the time display
            })
            .catch(error => {
                console.error('Error saving display mode:', error);
            });
        });
        // Initialize noUiSlider for Brightness
        var brightnessSlider = document.getElementById('brightnessSlider');
        noUiSlider.create(brightnessSlider, {
            start: [brightness],
            connect: [true, false],
            orientation: 'vertical',
            direction: 'rtl',
            range: {
                'min': 0,
                'max': 255
            }
        });
        // Brightness Slider Event Listener
        brightnessSlider.noUiSlider.on('slide', debounce(function(values, handle) {
            if (isInitializing) return;
        
            brightness = Math.round(values[handle]);
            document.getElementById('brightnessValue').textContent = brightness;
        
            // Send the brightness to the server
            fetch('/setLEDSettings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brightness: brightness })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Brightness saved on server:', data);
            })
            .catch(error => {
                console.error('Error saving brightness:', error);
            });
        }, debounce_time));
        
        // Initialize noUiSlider for Volume
        var volumeSlider = document.getElementById('volumeSlider');
        noUiSlider.create(volumeSlider, {
            start: [volume],
            connect: [true, false],
            orientation: 'vertical',
            direction: 'rtl',
            range: {
                'min': 0,
                'max': 21
            },
            step: 1
        });
        
        // Volume Slider Event Listener
        volumeSlider.noUiSlider.on('slide', debounce(function(values, handle) {            volume = Math.round(values[handle]);
            document.getElementById('volumeValue').textContent = volume;
        
            if (isInitializing) return; // Prevent fetch during initialization
        
            // Send the volume to the server
            fetch('/setAudioSettings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ volume: volume })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Volume saved on server:', data);
            })
            .catch(error => {
                console.error('Error saving volume:', error);
            });
        }, debounce_time));
        // Initialize iro.js for Global Color Picker
        const colorPicker = document.getElementById('colorPicker');
        const globalColorPicker = new iro.ColorPicker('#colorPicker', {
            width: 200,
            color: color,
            layout: [
                {
                    component: iro.ui.Wheel,
                    options: {}
                }
            ]
        });
        
        // Debug: Check if the color picker is correctly initialized
        console.log('Color Picker Initialized:', globalColorPicker);
        
        // Activate the color picker on click
        const colorPickerContainer = document.getElementById('colorPickerContainer');
        const colorPickerElement = document.getElementById('colorPicker');
        
        // Ensure click events are detected
        colorPickerContainer.addEventListener('click', (event) => {
            console.log('Color picker container clicked'); // Debug log
            colorPickerElement.classList.add('active'); // Add 'active' state
            event.stopPropagation(); // Prevent click from bubbling up
        });
        
        // Close the color picker when clicking outside
        document.addEventListener('click', (event) => {
            if (!colorPickerContainer.contains(event.target)) {
                console.log('Click detected outside of color picker'); // Debug log
                colorPickerElement.classList.remove('active'); // Remove 'active' state
            }
        });
        
        // Debounce function
        function debounce(func, delay) {
            let debounceTimer;
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }
        // Update the global color picker event to reset individual digit and colon colors
        globalColorPicker.on('color:change', debounce(function(colorInstance) {            if (isInitializing) return; // Do nothing if initializing
            color = colorInstance.hexString;
            // Reset individual digit and colon colors
            digitColors = [null, null, null, null];
            colonColor = null;
            // Update the digit display
            updateDigitDisplay(lastHours, lastMinutes);
            // Send the color to the server and reset individual colors
            fetch('/setLEDSettings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ color: color })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Color saved on server and individual colors reset:', data);
            })
            .catch(error => {
                console.error('Error saving color:', error);
            });
        }, debounce_time));
        // Initialize iro.js for Digit Color Picker
        const digitColorPicker = new iro.ColorPicker('#digitColorPicker', {
            width: 200,
            color: '#008000',
            layout: [
                {
                    component: iro.ui.Wheel,
                    options: {}
                }
            ]
        });
        // Variables for the modal
        const digitColorPickerModal = document.getElementById('digitColorPickerModal');
        const closeDigitColorPicker = document.getElementById('closeDigitColorPicker');
        const confirmDigitColorButton = document.getElementById('confirmDigitColorButton');
        // Open the modal when a digit or colon is clicked
        function openDigitColorPickerModal() {
            digitColorPickerModal.style.display = 'block';
        
            // Show the disable zero options only if the first digit is selected
            if (selectedElement && selectedElement.type === 'digit' && selectedElement.index === 0) {
                document.getElementById('disableZeroOptions').style.display = 'block';
                // Load the current settings into the checkboxes
                document.getElementById('disableZero24hr').checked = disableZeroSettings.disable24hr || false;
                document.getElementById('disableZero12hr').checked = disableZeroSettings.disable12hr || false;
                document.getElementById('disableZeroCountdown').checked = disableZeroSettings.disableCountdown || false;
            } else {
                document.getElementById('disableZeroOptions').style.display = 'none';
            }
        }
        
        // Close the modal when the user clicks on <span> (x)
        closeDigitColorPicker.onclick = function() {
            digitColorPickerModal.style.display = 'none';
            selectedElement = null;
        }
        
        // Close the modal when the user clicks the "OK" button
        confirmDigitColorButton.onclick = function() {
            // Save the disable zero settings if the first digit is selected
            if (selectedElement && selectedElement.type === 'digit' && selectedElement.index === 0) {
                disableZeroSettings.disable24hr = document.getElementById('disableZero24hr').checked;
                disableZeroSettings.disable12hr = document.getElementById('disableZero12hr').checked;
                disableZeroSettings.disableCountdown = document.getElementById('disableZeroCountdown').checked;
        
                // Send the settings to the server
                fetch('/setDisableZeroSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(disableZeroSettings)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Disable zero settings saved on server:', data);
                })
                .catch(error => {
                    console.error('Error saving disable zero settings:', error);
                });
            }
            digitColorPickerModal.style.display = 'none';
            selectedElement = null;
        }
        
        // Close the modal when the user clicks anywhere outside of the modal
        window.onclick = function(event) {
            if (event.target == digitColorPickerModal) {
                digitColorPickerModal.style.display = 'none';
                selectedElement = null;
            }
        }
        // Handle color change for individual digits or colon
        digitColorPicker.on('color:change', debounce(function(colorInstance) {
            if (selectedElement) {
                const selectedColor = colorInstance.hexString;
                if (selectedElement.type === 'digit') {
                    digitColors[selectedElement.index] = selectedColor;
                } else if (selectedElement.type === 'colon') {
                    colonColor = selectedColor;
                }
                // Update the digit display
                updateDigitDisplay(lastHours, lastMinutes);
                // Send the updated digit or colon color to the server
                fetch('/setDigitColor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: selectedElement.type,
                        index: selectedElement.index,
                        color: selectedColor
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Digit or colon color saved on server:', data);
                })
                .catch(error => {
                    console.error('Error saving digit or colon color:', error);
                });
            }
        }, debounce_time));
        // Handle click event for audioStreamToggle
        document.getElementById('audioStreamToggle').addEventListener('click', function() {
            isStreaming = !isStreaming;
            this.classList.toggle('enabled', isStreaming);
            this.textContent = isStreaming ? 'Audio Stream On' : 'Audio Stream Off';
        
            // Send the stream state to the server
            fetch('/setStreamState', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ isStreaming: isStreaming })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Stream state updated on server:', data);
            })
            .catch(error => {
                console.error('Error updating stream state:', error);
            });
        });
        // Initialize noUiSlider for Alarm Volume in the modal
        var alarmVolumeSlider = document.getElementById('alarmVolumeSlider');
        noUiSlider.create(alarmVolumeSlider, {
            start: [volume],
            connect: [true, false],
            orientation: 'vertical',
            direction: 'rtl',
            range: {
                'min': 0,
                'max': 21
            },
            step: 1
        });
        // Alarm Volume Slider Event Listener
        alarmVolumeSlider.noUiSlider.on('slide', debounce(function(values, handle) {
            const alarmVolume = Math.round(values[handle]);
            document.getElementById('alarmVolumeValue').textContent = alarmVolume;
        
            // Update the selected alarm's volume
            if (selectedAlarmIndex !== null && alarms[selectedAlarmIndex]) {
                alarms[selectedAlarmIndex].volume = alarmVolume;
            }
        }, debounce_time));
        function openDaySelectionModal(index) {
            selectedAlarmIndex = index;
            const alarm = alarms[index];
            alarmSearchEnabled = true;
            // Generate the day buttons
            const daySelectionContainer = document.getElementById('daySelectionContainer');
            daySelectionContainer.innerHTML = ''; // Clear previous content
        
            const daysOfWeek = ['Sun', 'Mon', 'Tues', 'Wed', 'Thur', 'Fri', 'Sat'];
        
            daysOfWeek.forEach((dayName, dayIndex) => {
                const dayButton = document.createElement('button');
                dayButton.className = 'day-button';
                dayButton.textContent = dayName;
                dayButton.dataset.dayIndex = dayIndex;
                dayButton.style.margin = '2px';
        
                // Check if the day is selected
                if (alarm.days.includes(dayIndex)) {
                    dayButton.classList.add('selected');
                }
        
                dayButton.addEventListener('click', () => {
                    dayButton.classList.toggle('selected');
                });
        
                daySelectionContainer.appendChild(dayButton);
            });
        
            // Set the volume slider to the alarm's volume or default
            const alarmVolume = alarm.volume !== undefined ? alarm.volume : volume; // Use global volume if not set
            alarmVolumeSlider.noUiSlider.set(alarmVolume);
            document.getElementById('alarmVolumeValue').textContent = alarmVolume;
        
        
            // Get the alarmStreamURL input element
            const alarmStreamURLInput = document.getElementById('alarmStreamURL');
        
            // Remove any existing 'change' event listener
            alarmStreamURLInput.removeEventListener('change', handleAlarmStreamSubmission);
        
            // Add event listener for stream URL search
            alarmStreamURLInput.addEventListener('change', handleAlarmStreamSubmission);
        
            // Open the modal
            const daySelectionModal = document.getElementById('daySelectionModal');
            openModal(daySelectionModal);
        }
        
        function searchForAlarmStations(query) {
            // Similar to searchForStations, but results are displayed in the modal
            const encodedQuery = encodeURIComponent(query);
            const radioApiUrl = `https://de1.api.radio-browser.info/json/stations/bytag/${encodedQuery}?hidebroken=true&order=votes&reverse=true`;
            const youtubeApiUrl = `https://vahub.ca/youtube_search?query=${encodedQuery}`;
        
            Promise.allSettled([
                fetch(radioApiUrl).then(response => response.json()),
                fetch(youtubeApiUrl).then(response => response.json())
            ])
            .then((results) => {
                const [radioResult, youtubeResult] = results;
        
                let radioStations = [];
                let youtubeResults = [];
        
                if (radioResult.status === 'fulfilled') {
                    radioStations = radioResult.value.filter(station => station.bitrate > 0);
                }
        
                if (youtubeResult.status === 'fulfilled') {
                    youtubeResults = youtubeResult.value;
                }
        
                const allResults = {
                    stations: radioStations,
                    youtube: youtubeResults
                };
        
                showAlarmSearchResults(allResults);
        
                // Hide the loading indicator
                document.getElementById('alarmLoadingIndicator').style.display = 'none';
            })
            .catch(error => {
                console.error('Error processing search results:', error);
                alert('Error processing search results. Please try again.');
        
                // Hide the loading indicator
                document.getElementById('alarmLoadingIndicator').style.display = 'none';
            });
        }
        
        function showAlarmSearchResults(results) {
            const searchResultsContainer = document.getElementById('alarmSearchResults');
            searchResultsContainer.innerHTML = ''; // Clear previous results
            const { stations, youtube } = results;
        
            // Handle Radio Stations
            stations.slice(0, 20).forEach(station => {
                const stationItem = createAlarmStationItem(station);
                searchResultsContainer.appendChild(stationItem);
            });
        
            // Handle YouTube Results
            youtube.forEach(video => {
                const youtubeItem = createAlarmYouTubeItem(video);
                searchResultsContainer.appendChild(youtubeItem);
            });
        }
        
        function createAlarmStationItem(station) {
            const stationItem = document.createElement('div');
            stationItem.className = 'station-item';
        
            const title = document.createElement('h3');
            title.textContent = station.name;
        
            const description = document.createElement('p');
            description.textContent = `Tags: ${station.tags}`;
        
            const setButton = document.createElement('button');
            setButton.className = 'set-alarm-button';
            setButton.textContent = 'Set As Alarm';
            setButton.style.backgroundColor = 'var(--button-bg-color)';
            setButton.style.border= '1px solid var(--slider-fill-color)';
            setButton.style.color = 'var(--button-text-color)';
            setButton.style.borderRadius = '20px';
        
            setButton.addEventListener('click', () => {
                alarms[selectedAlarmIndex].streamURL = station.url_resolved;
                // Disable search triggering before updating the input
                alarmSearchEnabled = false;
                document.getElementById('alarmStreamURL').value = station.url;
                alert(`Stream set for the alarm: ${station.name}`);
                // Collapse search results
                document.getElementById('alarmSearchResults').innerHTML = '';
                // Hide the loading indicator if necessary
                document.getElementById('alarmLoadingIndicator').style.display = 'none';
            });
        
            stationItem.appendChild(title);
            stationItem.appendChild(description);
            stationItem.appendChild(setButton);
        
            return stationItem;
        }
        
        function createAlarmYouTubeItem(video) {
            const youtubeItem = document.createElement('div');
            youtubeItem.className = 'youtube-item';
        
            const title = document.createElement('h3');
            title.textContent = video.title;
        
            const setButton = document.createElement('button');
            setButton.className = 'set-alarm-button';
            setButton.textContent = 'Set As Alarm';
            setButton.style.backgroundColor = 'var(--button-bg-color)';
            setButton.style.border= '1px solid var(--slider-fill-color)';
            setButton.style.color = 'var(--button-text-color)';
            setButton.style.borderRadius = '20px';
        
            setButton.addEventListener('click', () => {
                const encodedURL = encodeURIComponent(video.url);
                const streamURL = `http://vahub.ca/stream_youtube?url=${encodedURL}&user=${Date.now()}`;
                alarms[selectedAlarmIndex].streamURL = streamURL;
        
                // Remove 'change' event listener
                const alarmStreamURLInput = document.getElementById('alarmStreamURL');
                alarmStreamURLInput.removeEventListener('change', handleAlarmStreamSubmission);
        
                // Set the value
                alarmStreamURLInput.value = video.title;
        
                // Re-attach the event listener
                alarmStreamURLInput.addEventListener('change', handleAlarmStreamSubmission);
        
                // Collapse search results
                document.getElementById('alarmSearchResults').innerHTML = '';
            });
        
            youtubeItem.appendChild(title);
            youtubeItem.appendChild(setButton);
        
            return youtubeItem;
        }
        
        document.getElementById('alarmStreamURL').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default action
                if (alarmSearchEnabled) {
                    handleAlarmStreamSubmission();
                }
            } else {
                // Optionally, you can trigger search on every keyup except Enter
                // handleAlarmStreamSubmission();
            }
        });
        
        function handleAlarmStreamSubmission() {
            const searchQuery = document.getElementById('alarmStreamURL').value.trim();
            if (searchQuery === '') {
                // Clear search results
                document.getElementById('alarmSearchResults').innerHTML = '';
                return;
            }
        
            // Show the loading indicator
            document.getElementById('alarmLoadingIndicator').style.display = 'block';
            document.getElementById('alarmSearchResults').innerHTML = ''; // Clear previous results
        
            if (isYouTubeURL(searchQuery) || isValidURL(searchQuery)) {
                // Directly set the URL
                alarms[selectedAlarmIndex].streamURL = searchQuery;
                alert('Stream URL set for the alarm.');
                // Hide the loading indicator
                document.getElementById('alarmLoadingIndicator').style.display = 'none';
                // Collapse the search results
                document.getElementById('alarmSearchResults').innerHTML = '';
                // Disable search triggering
                alarmSearchEnabled = false;
            } else {
                // Perform search
                searchForAlarmStations(searchQuery);
            }
        }
        
        document.getElementById('saveDaySelectionButton').addEventListener('click', saveDaySelection);
        
        function saveDaySelection() {
            const dayButtons = document.querySelectorAll('#daySelectionContainer .day-button');
            const selectedDays = [];
        
            dayButtons.forEach(button => {
                if (button.classList.contains('selected')) {
                    selectedDays.push(parseInt(button.dataset.dayIndex));
                }
            });
        
            if (selectedDays.length === 0) {
                // Default to every day if none selected
                selectedDays.push(0,1,2,3,4,5,6);
            }
        
            // Get the volume and stream URL
            const alarmVolume = alarms[selectedAlarmIndex].volume;
            const alarmStreamURL = document.getElementById('alarmStreamURL').value.trim();
        
            // Update the alarm's days, volume, and streamURL
            alarms[selectedAlarmIndex].days = selectedDays;
            alarms[selectedAlarmIndex].streamURL = alarmStreamURL;
        
            // Close the modal
            const daySelectionModal = document.getElementById('daySelectionModal');
            closeModal(daySelectionModal);
        
            // Re-render alarms
            renderAlarms();
        
            // Update alarms on server
            updateAlarmsOnServer();
        }
        
        document.getElementById('closeDaySelectionModal').addEventListener('click', () => {
            const daySelectionModal = document.getElementById('daySelectionModal');
            closeModal(daySelectionModal);
        });
        
        // Function to add a new alarm to the UI and server
        function addAlarm() {
            if (alarms.length >= MAX_ALARMS) {
                alert(`Maximum of ${MAX_ALARMS} alarms reached.`);
                return;
            }
        
            const defaultTime = '';
        
            const newAlarm = {
                time: defaultTime,
                enabled: false,
                days: [0,1,2,3,4,5,6]  // Default to every day
            };
        
            alarms.push(newAlarm);
            renderAlarms();
            updateAlarmsOnServer();
        
            // Auto-focus the new alarm's time input
            setTimeout(() => {
                const alarmsList = document.getElementById('alarmsList');
                const lastAlarm = alarmsList.lastElementChild;
                if (lastAlarm) {
                    const timeInput = lastAlarm.querySelector('.alarm-time');
                    if (timeInput) {
                        timeInput.focus();
                    }
                }
            }, 100); // Slight delay to ensure the alarm is rendered
        
            // Check for duplicates and notify the user
            const duplicateCount = alarms.filter(alarm => alarm.time === defaultTime).length;
            if (duplicateCount > 1) {
                alert(`You already have an alarm without a set time. Consider deleting or modifying it first.`);
            }
        }
        
        
        
        
        /// Function to render all alarms in the UI
        function renderAlarms() {
            const alarmsList = document.getElementById('alarmsList');
            alarmsList.innerHTML = ''; // Clear existing alarms
        
            alarms.forEach((alarm, index) => {
                const li = document.createElement('li');
                li.className = 'alarm-item';
        
                // Toggle Button
                const toggleButton = document.createElement('button');
                toggleButton.className = `toggle-alarm ${alarm.enabled ? 'on' : 'off'}`;
                toggleButton.textContent = alarm.enabled ? 'ON' : 'OFF';
                toggleButton.title = 'Toggle Alarm';
        
                toggleButton.addEventListener('click', () => {
                    toggleAlarm(index);
                });
        
                // Time Input
                const timeInput = document.createElement('input');
                timeInput.type = 'time';
                timeInput.value = alarm.time;
                timeInput.className = 'alarm-time';
                timeInput.setAttribute('aria-label', 'Alarm Time');
                timeInput.style.backgroundColor = 'var(--container-bg-color)';
                timeInput.style.color = 'var(--text-color)';
                timeInput.style.border = '1px solid var(--slider-fill-color)';
                timeInput.style.borderRadius = '20px';
        
                timeInput.addEventListener('blur', (e) => {
                    updateAlarmTime(index, e.target.value);
                });
        
                // Delete Button
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-alarm';
                deleteButton.innerHTML = '&times;';
                deleteButton.title = 'Delete Alarm';
                deleteButton.addEventListener('click', () => {
                    deleteAlarm(index);
                });
        
                // Days Button
                const daysButton = document.createElement('button');
                daysButton.className = 'days-button';
                daysButton.textContent = 'Settings';
                daysButton.title = 'Settings for Alarm';
                daysButton.addEventListener('click', () => {
                    openDaySelectionModal(index); // Attach event listener to open the modal
                });
        
                li.appendChild(toggleButton);
                li.appendChild(timeInput);
                li.appendChild(daysButton);
                li.appendChild(deleteButton);
                alarmsList.appendChild(li);
            });
        }
        
        
        // Function to load alarms from the server and render them
        function loadAlarms() {
            fetchWithRetry('/getAlarmSettings')
                .then(response => response.json())
                .then(data => {
                    alarms = data.alarms || [];
                    alarms.forEach(alarm => {
                        // Ensure each alarm has a 'days' property with default value
                        if (!alarm.hasOwnProperty('days') || !Array.isArray(alarm.days)) {
                            alarm.days = [0, 1, 2, 3, 4, 5, 6];  // Default to every day
                        }
                        // Set default volume and streamURL if not present
                        if (!alarm.hasOwnProperty('volume')) {
                            alarm.volume = volume;
                        }
                        if (!alarm.hasOwnProperty('streamURL')) {
                            alarm.streamURL = streamURL;
                        }
                    });
                    renderAlarms();
                })
                .catch(error => {
                    console.error('Error fetching alarms:', error);
                });
        }
        
        
        
        
        
        // Function to toggle an alarm's enabled state
        function toggleAlarm(index) {
            alarms[index].enabled = !alarms[index].enabled;
            renderAlarms();
            updateAlarmsOnServer();
        }
        
        // Function to update an alarm's time
        function updateAlarmTime(index, newTime) {
            // Trim and validate the newTime format if necessary
            newTime = newTime.trim();
        
            // Check if another alarm already has the newTime
            const duplicate = alarms.some((alarm, i) => alarm.time === newTime && i !== index);
            if (duplicate) {
                alert(`Another alarm is already set for ${newTime}. Please choose a different time.`);
                // Optionally, revert the change or keep the previous time
                // For simplicity, we'll prevent the update
                return;
            }
        
            alarms[index].time = newTime;
            renderAlarms();
            updateAlarmsOnServer();
        }
        
        // Function to delete an alarm
        function deleteAlarm(index) {
            const confirmDelete = confirm('Are you sure you want to delete this alarm?');
            if (confirmDelete) {
                alarms.splice(index, 1);
                renderAlarms();
                updateAlarmsOnServer();
            }
        }
        function formatDays(daysArray) {
            if (!daysArray || daysArray.length === 0 || daysArray.length === 7) {
                return 'Every day';
            }
        
            const daysOfWeekAbbrev = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
            const selectedDays = daysArray.map(dayIndex => daysOfWeekAbbrev[dayIndex]);
        
            return selectedDays.join(', ');
        }
        // Function to update alarms on the server
        function updateAlarmsOnServer() {
            fetch('/setAlarmSettings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ alarms: alarms })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Alarms updated on server:', data);
            })
            .catch(error => {
                console.error('Error updating alarms:', error);
            });
        }
        
        
        // Event Listener for Add Alarm Button
        document.getElementById('addAlarmButton').addEventListener('click', function() {
            addAlarm();
        });
        
        async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`Fetch error: ${response.statusText}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Retrying fetch to ${url}. Attempts left: ${retries}`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(url, options, retries - 1, delay);
                } else {
                    throw error;
                }
            }
        }
        
        // Initial fetch of alarms when the page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Load the theme from localStorage
                const savedThemeIndex = localStorage.getItem('currentThemeIndex');
                if (savedThemeIndex !== null) {
                    currentThemeIndex = parseInt(savedThemeIndex, 10);
                    applyTheme(themes[currentThemeIndex]);
                } else {
                    // If no theme is saved, apply the default theme
                    applyTheme(themes[currentThemeIndex]);
                }
                // Load Alarms
                await loadAlarms();
                // Fetch getAudioSettings
                let response = await fetchWithRetry('/getAudioSettings');
                if (!response.ok) {
                    throw new Error(`Network response was not ok (${response.statusText})`);
                }
                let data = await response.json();
                streamName = data.streamName;
                console.log('On Page Load: ', streamName);
                updateCurrentStreamTitle(streamName || 'No stream Playing...');
        
                // Fetch getSettings
                response = await fetchWithRetry('/getSettings');
                if (!response.ok) {
                    throw new Error(`Network response was not ok (${response.statusText})`);
                }
                data = await response.json();
                console.log(data);
                // Update variables from fetched data
                displayMode = data.mode;
                brightness = data.brightness || 128;
                color = data.color || '#008000';
                volume = data.volume || 10;
                isStreaming = data.isStreaming || false;
                streamURL = '';
                timeZoneString = data.timeZoneString || 'UTC0';
        
                // Update is24HourFormat from data
                if (data.hasOwnProperty('is24HourFormat')) {
                    is24HourFormat = data.is24HourFormat;
                } else {
                    is24HourFormat = true; // default value
                }
        
                // Update hour format toggle button text
                document.getElementById('hourFormatToggle').textContent = is24HourFormat ? '24 Hour Format' : '12 Hour Format';
        
                // Load favourites from local storage
                loadFavourites();
        
                // Ensure digitColors is an array
                if (data.digitColors && Array.isArray(data.digitColors)) {
                    digitColors = data.digitColors.map(c => c || null);
                } else {
                    digitColors = [null, null, null, null];
                }
        
                // Update colon color if provided
                colonColor = (data.colonColors && Array.isArray(data.colonColors)) ? data.colonColors[0] || null : null;
        
                // Set global color if individual digit colors are all null
                const allNullDigits = digitColors.every(c => c === null);
                if (allNullDigits && colonColor === null) {
                    globalColorPicker.color.hexString = color;
                }
        
                // Update UI elements
                document.getElementById('displayModeToggle').textContent = 'Display Mode: ' + displayMode.charAt(0).toUpperCase() + displayMode.slice(1);
        
                // Update sliders inside isInitializing block
                isInitializing = true;
                brightnessSlider.noUiSlider.set(brightness);
                volumeSlider.noUiSlider.set(volume);
                isInitializing = false;
        
                document.getElementById('brightnessValue').textContent = brightness;
                document.getElementById('volumeValue').textContent = volume;
        
                // Update stream state and URL
                document.getElementById('audioStreamToggle').classList.toggle('enabled', isStreaming);
                document.getElementById('audioStreamToggle').textContent = isStreaming ? 'Audio Stream On' : 'Audio Stream Off';
                document.getElementById('streamURL').value = streamURL;
        
                // Since alarms are already loaded, no need to call loadAlarms() again
        
                // Fetch time to update the display
                fetchTime();
                // Call the function to fetch the initial state
                fetchAutoBrightnessState();
        
                // Fetch disable zero settings from the server
                fetch('/getDisableZeroSettings')
                    .then(response => response.json())
                    .then(data => {
                        disableZeroSettings = {
                            disable24hr: data.disable24hr || false,
                            disable12hr: data.disable12hr || false,
                            disableCountdown: data.disableCountdown || false
                        };
                    })
                    .catch(error => {
                        console.error('Error fetching disable zero settings:', error);
                    });
        
        
            } catch (error) {
                console.error('Error during initialization:', error);
                fetchTime(); // Ensure time display is updated even if there's an error
            }
        });
        
        
        // Function to handle stream URL or genre submission
        function handleStreamSubmission() {
            streamURL = document.getElementById('streamURL').value.trim();
            if (streamURL === '') {
                updateCurrentStreamTitle('No stream playing');
                return;
            }
            if (isYouTubeURL(streamURL)) {
                // Handle YouTube URL directly with the ESP
                updateCurrentStreamTitle('YouTube Stream');
                console.log('YouTube URL detected, sending to ESP...');
        
                const encodedURL = encodeURIComponent(streamURL);  // Properly encode the URL
                const fullStreamURL = `http://vahub.ca/stream_youtube?url=${encodedURL}&user=${Date.now()}`;  // Unique user stream
        
                console.log(`Streaming URL: ${fullStreamURL}`);
                playStream(fullStreamURL);  // Send the stream URL directly to the ESP
            }
            else if (isValidURL(streamURL)) {
                // Handle non-YouTube URLs
                updateCurrentStreamTitle(streamURL);
                playStream(streamURL);  // Directly play the stream URL
            }
            else {
                // Treat input as a genre search if not a valid URL
                searchForStations(streamURL);
            }
            mainSearchEnabled = false;
        }
        
        // New 'keydown' event listener to handle Enter key
        document.getElementById('streamURL').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (mainSearchEnabled) {
                    console.log("Main search enabled");
                    handleStreamSubmission();
                }
            }
        });
        
        function updateStatusMessage(message, show = true) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.style.display = show ? 'block' : 'none';
        }
        async function searchRadioStations(query) {
            const response = await fetch(`/radio_search?query=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error('Failed to fetch radio stations');
            return response.json();
        }
        
        async function searchYouTube(query) {
            const response = await fetch(`/youtube_search?query=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error('Failed to fetch YouTube results');
            return response.json();
        }
        
        let searchMessageTimeout; // Declare this variable at a higher scope to clear it later
        function displaySpinnerInStationList() {
            const stationList = document.getElementById('stationList');
            stationList.innerHTML = `
                <div class="spinner-container">
                    <div class="modal-spinner"></div>
                    <p id="searchMessage">Beginning search...</p>
                </div>
            `;
        
            const searchMessages = [
                "Beginning search...",
                "Applying your filters...",
                "Looking for radio stations...",
                "Browsing YouTube...",
                "Checking availability...",
                "Fine-tuning results...",
                "Decoding audio streams...",
                "Setting up results..."
            ];
        
            let messageIndex = 0;
            const searchMessageElement = document.getElementById('searchMessage');
        
            // Start the message cycling
            function showNextMessage() {
                // Fade out the current message
                searchMessageElement.style.opacity = 0;
        
                setTimeout(() => {
                    // Update message index
                    messageIndex = (messageIndex + 1) % searchMessages.length;
                    // Change the message
                    searchMessageElement.textContent = searchMessages[messageIndex];
                    // Fade in the new message
                    searchMessageElement.style.opacity = 1;
                }, 500); // Fade out duration
        
                // Schedule next message
                searchMessageTimeout = setTimeout(showNextMessage, 2000); // Adjust timing as needed
            }
        
            // Start the cycle after initial display duration
            searchMessageTimeout = setTimeout(showNextMessage, 2000);
        }
        
        
        function searchForStations(genre) {
            // Open the modal and display the spinner with dynamic messages
            openModal(stationListModal);
            displaySpinnerInStationList();
        
            const encodedGenre = encodeURIComponent(genre);
            const radioApiUrl = `https://de1.api.radio-browser.info/json/stations/bytag/${encodedGenre}?hidebroken=true&order=votes&reverse=true`;
            const youtubeApiUrl = `https://vahub.ca/youtube_search?query=${encodedGenre}`;
        
            Promise.allSettled([
                fetch(radioApiUrl).then(response => response.json()),
                fetch(youtubeApiUrl).then(response => response.json())
            ])
            .then((results) => {
                const [radioResult, youtubeResult] = results;
        
                let radioStations = [];
                let youtubeResults = [];
        
                if (radioResult.status === 'fulfilled') {
                    radioStations = radioResult.value.filter(station => station.bitrate > 0);
                } else {
                    console.error('Error fetching radio stations:', radioResult.reason);
                }
        
                if (youtubeResult.status === 'fulfilled') {
                    youtubeResults = youtubeResult.value;
                } else {
                    console.error('Error fetching YouTube results:', youtubeResult.reason);
                }
        
                const allResults = {
                    stations: radioStations,
                    youtube: youtubeResults
                };
        
                // Stop the message loop and set the final message
                clearTimeout(searchMessageTimeout);
        
                // Update the message to "Setting up results..."
                const searchMessageElement = document.getElementById('searchMessage');
                if (searchMessageElement) {
                    searchMessageElement.textContent = "Setting up results...";
                    searchMessageElement.style.opacity = 1; // Ensure it's visible
                }
        
                // Introduce a brief delay before showing results
                setTimeout(() => {
                    showStationListModal(allResults, genre);  // Pass combined results to the modal
                }, 1000); // Delay of 1 second
        
            })
            .catch(error => {
                console.error('Error processing search results:', error);
                alert('Error processing search results. Please try again.');
        
                // Clear the timeout
                clearTimeout(searchMessageTimeout);
        
                closeModal(stationListModal);
            });
        }
        
        
        function sendStreamName(name) {
            fetch('/setAudioSettings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ streamName: name })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Stream NAME sent to ESP:', data);
            })
            .catch(error => {
                console.error('Error sending stream NAME to ESP:', error);
            });
        }
        
        function showStationListModal(results, genre) {
            const stationList = document.getElementById('stationList');
            stationList.innerHTML = ''; // Clear previous results
            clearTimeout(searchMessageTimeout);
            const { stations, youtube } = results;
        
            // Handle Radio Stations
            const filteredStations = stations.filter(station => station.bitrate > 0);
            const uniqueStations = [];
            const stationUrls = new Set();
        
            filteredStations.slice(0, 20).forEach(station => {
                const streamUrl = station.url_resolved.toLowerCase();
                const codec = (station.codec || '').toLowerCase();
                const stationName = station.name.toLowerCase();
        
                // Exclude unwanted streams and formats
                const isM3U8 = streamUrl.endsWith('.m3u8');
                const isAACPlus = streamUrl.endsWith('.aacp') || codec === 'aac+';
                const isPLS = streamUrl.endsWith('.pls');
                const isMP3Pro = codec === 'mp3pro';
                const isOGG = codec === 'ogg';
                const containsHD = streamUrl.includes('hd') || stationName.includes('hd');
        
                if (!isM3U8 && !isAACPlus && !isPLS && !isMP3Pro && !isOGG && !containsHD) {
                    if (!stationUrls.has(streamUrl)) {
                        stationUrls.add(streamUrl);
                        uniqueStations.push(station);
                    }
                }
            });
        
            if (uniqueStations.length === 0) {
                const noStations = document.createElement('p');
                noStations.textContent = `No radio stations found for: ${genre}`;
                stationList.appendChild(noStations);
            } else {
                uniqueStations.forEach(station => {
                    const stationItem = createStationItem(station);
                    stationList.appendChild(stationItem);
                });
            }
        
            // Handle YouTube Results
            if (youtube && youtube.length > 0) {
                youtube.forEach(video => {
                    const youtubeItem = createYouTubeItem(video);
                    stationList.appendChild(youtubeItem);
                });
            } else {
                const noYouTube = document.createElement('p');
                noYouTube.textContent = `No YouTube videos found for: ${genre}`;
                stationList.appendChild(noYouTube);
            }
        
            openModal(stationListModal); // Show the modal
        }
        
        // Helper to create a radio station item
        function createStationItem(station) {
            const stationItem = document.createElement('div');
            stationItem.className = 'station-item';
        
            const radioIcon = document.createElement('div');
            radioIcon.className = 'radio-icon';
        
            const outerArc = document.createElement('div');
            outerArc.className = 'radio-arc-outer';
        
            const innerArc = document.createElement('div');
            innerArc.className = 'radio-arc-inner';
        
            // Append arcs to the radio icon
            radioIcon.appendChild(outerArc);
            radioIcon.appendChild(innerArc);
        
            const title = document.createElement('h3');
            title.textContent = station.name;
        
            const description = document.createElement('p');
            description.textContent = `Tags: ${station.tags}`;
        
            const bitrateInfo = document.createElement('p');
            bitrateInfo.textContent = `Bitrate: ${station.bitrate} kbps, ${station.codec || 'Unknown'}`;
        
            const playButton = createPlayButton(station.url_resolved, station.name);
            const favoriteButton = createFavoriteButton(station);
        
            stationItem.appendChild(radioIcon);
            stationItem.appendChild(title);
            stationItem.appendChild(description);
            stationItem.appendChild(bitrateInfo);
            stationItem.appendChild(playButton);
            stationItem.appendChild(favoriteButton);
        
            return stationItem;
        }
        
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }
        
        function createYouTubeItem(video) {
            const youtubeItem = document.createElement('div');
            youtubeItem.className = 'youtube-item'; // Changed class name for clarity
        
            // YouTube Icon
            const youtubeIcon = document.createElement('div');
            youtubeIcon.className = 'youtube-icon';
        
            const thumbnailContainer = document.createElement('div');
            thumbnailContainer.className = 'thumbnail-container';
        
            const thumbnail = document.createElement('img');
            thumbnail.src = video.thumbnail;
            thumbnail.alt = `${video.title} Thumbnail`;
            thumbnail.className = 'youtube-thumbnail'; // Add class for styling
        
            const infoContainer = document.createElement('div');
            infoContainer.className = 'info-container';
        
            const title = document.createElement('h3');
            title.textContent = video.title;
        
            const duration = document.createElement('p');
            duration.textContent = `Duration: ${formatDuration(video.duration)}`;
        
            const playButton = createPlayButton(video.url, video.title);
        
            // Create and append the favorite button
            const favoriteButton = createYouTubeFavoriteButton(video);
            infoContainer.appendChild(favoriteButton);
        
            // Append elements to their respective containers
            thumbnailContainer.appendChild(thumbnail);
            infoContainer.appendChild(youtubeIcon);
            infoContainer.appendChild(title);
            infoContainer.appendChild(duration);
            infoContainer.appendChild(playButton);
        
            youtubeItem.appendChild(thumbnailContainer);
            youtubeItem.appendChild(infoContainer);
        
            return youtubeItem;
        }
        
        function createYouTubeFavoriteButton(video) {
            const favoriteButton = document.createElement('button');
            favoriteButton.className = 'favorite-button';
            favoriteButton.innerHTML = '&#9734;'; // Empty star icon
            favoriteButton.title = 'Add to Favorites';
        
            // Check if the video is already in favorites
            if (favourites.find(fav => fav.url === video.url)) {
                favoriteButton.innerHTML = '&#9733;'; // Filled star icon
                favoriteButton.classList.add('favorited');
            }
        
            favoriteButton.addEventListener('click', function () {
                addFavourite(video);
                favoriteButton.innerHTML = '&#9733;'; // Filled star icon
                favoriteButton.classList.add('favorited');
                loadFavourites();
            });
        
            return favoriteButton;
        }
        
        
        // Helper to create a play button
        function createPlayButton(url, name) {
            const playButton = document.createElement('button');
            playButton.className = 'play-button';
            playButton.textContent = 'Play';
            playButton.style.backgroundColor = 'var(--button-bg-color)';
            playButton.style.borderRadius = '20px';
            playButton.style.color = 'var(--button-text-color)';
            playButton.style.border = '1px solid var(--slider-fill-color)';
        
            playButton.addEventListener('click', () => {
                let streamURL = url;
                if (isYouTubeURL(url)) {
                    const encodedURL = encodeURIComponent(url);
                    streamURL = `http://vahub.ca/stream_youtube?url=${encodedURL}&user=${Date.now()}`;
                }
                playStream(streamURL, name);
                closeModal(stationListModal);
            });
            return playButton;
        }
        
        
        // Helper to create a favorite button
        function createFavoriteButton(station) {
            const favoriteButton = document.createElement('button');
            favoriteButton.className = 'favorite-button';
            favoriteButton.innerHTML = '&#9734;'; // Empty star icon
            favoriteButton.title = 'Add to Favourites';
            favoriteButton.addEventListener('click', function () {
                addFavourite(station);
                favoriteButton.innerHTML = '&#9733;'; // Filled star icon
                favoriteButton.classList.add('favorited');
                loadFavourites();
            });
        
            if (favourites.find(fav => fav.url === station.url_resolved)) {
                favoriteButton.innerHTML = '&#9733;'; // Filled star icon
                favoriteButton.classList.add('favorited');
            }
        
            return favoriteButton;
        }
        
        // Function to add an item to favourites (radio station or YouTube video)
        function addFavourite(item) {
            // Determine the type of item (radio station or YouTube video)
            let name, url, type, thumbnail, duration, uploader;
        
            if (item.url_resolved && item.name) {
                // It's a radio station
                url = item.url_resolved;
                name = item.name;
                type = 'radio';
            } else if (item.url && item.title) {
                // It's a YouTube video
                url = item.url;
                name = item.title;
                type = 'youtube';
                thumbnail = item.thumbnail;
                duration = item.duration;
                uploader = item.uploader;
            } else {
                console.error('Unknown item type for favourite:', item);
                return;
            }
        
            // Check if the item is already in favourites
            const exists = favourites.some(fav => fav.url === url);
            if (exists) {
                return;
            }
        
            const favourite = {
                name: name,
                url: url,
                type: type
            };
        
            // Add additional fields for YouTube videos
            if (type === 'youtube') {
                favourite.thumbnail = thumbnail;
                favourite.duration = duration;
                favourite.uploader = uploader;
            }
        
            favourites.push(favourite);
            // Save to local storage
            localStorage.setItem('favourites', JSON.stringify(favourites));
            populateFavouritesList();
        }
        
        // Close modal when user clicks on <span> (x)
        document.getElementById('closeStationListModal').onclick = function() {
            clearTimeout(searchMessageTimeout);
            closeModal(stationListModal);
            mainSearchEnabled = true;
        };
        
        // Update window click listener to close modals correctly
        window.addEventListener('click', function(event) {
            if (event.target == stationListModal) {
                closeModal(stationListModal);
                mainSearchEnabled = true;
            }
        <!--            if (event.target == youtubeLinksModal) {-->
        <!--                closeModal(youtubeLinksModal);-->
        <!--            }-->
            if (event.target == digitColorPickerModal) {
                digitColorPickerModal.style.display = 'none';
                selectedElement = null;
            }
            if (event.target == daySelectionModal) {
                closeModal(daySelectionModal);
            }
        });
        // Function to determine if a URL is a YouTube link
        function isYouTubeURL(url) {
            const pattern = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\//;
            return pattern.test(url);
        }
        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        // Function to send the stream URL to the ESP device
        function sendStreamDataToESP(url, name) {
            fetch('/setAudioSettings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ streamURL: url, streamName: name })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Stream data sent successfully:', data);
            })
            .catch((error) => {
                console.error('Error sending stream data:', error);
            });
        }
        // Event listener for the hour format toggle button
        document.getElementById('hourFormatToggle').addEventListener('click', function() {
            is24HourFormat = !is24HourFormat;  // Toggle the format
        
            // Update button text
            this.textContent = is24HourFormat ? '24 Hour Format' : '12 Hour Format';
        
            // Send the hour format setting to the server (or ESP32)
            fetch('/setHourFormat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is24HourFormat: is24HourFormat })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Hour format saved on server:', data);
                fetchTime();  // Refresh the time display with the new format
            })
            .catch(error => {
                console.error('Error saving hour format:', error);
            });
        });
        // Function to fetch the current time from the server
        function fetchTime() {
            fetch('/getCurrentTime')
                .then(response => response.json())
                .then(data => {
                    let hours = data.hour;
                    let minutes = data.minute;
        
                    // Store the last known time
                    lastHours = hours;
                    lastMinutes = minutes;
        
                    // Adjust for 12-hour format if necessary
                    if (displayMode === 'time') {
                        if (!is24HourFormat) {
                            const ampm = hours >= 12 ? 'PM' : 'AM';
                            hours = hours % 12;
                            hours = hours ? hours : 12;  // Convert 0 to 12 for midnight
                            // Update AM/PM display if you have one
                            // document.getElementById('ampmDisplay').textContent = ampm;
                        } else {
                            // Clear AM/PM display if necessary
                            // document.getElementById('ampmDisplay').textContent = '';
                        }
                    }
        
                    // Handle countdown mode
                    if (displayMode === 'countdown') {
                        // Calculate time remaining until midnight
                        let hoursLeft = 23 - hours;
                        let minutesLeft = 59 - minutes;
                        // Adjust for rollover
                        if (minutesLeft < 0) {
                            minutesLeft += 60;
                            hoursLeft -= 1;
                        }
                        if (hoursLeft < 0) hoursLeft = 23;
                        hours = hoursLeft;
                        minutes = minutesLeft;
                    }
        
                    // Update the digit display
                    updateDigitDisplay(hours, minutes);
                })
                .catch(error => {
                    console.error("Error fetching time: ", error);
                });
        }
        
        // Function to update the digit display
        function updateDigitDisplay(hours, minutes) {
            const digitDisplay = document.getElementById('timeDisplay');
            digitDisplay.innerHTML = ''; // Clear previous content
        
            const timeDigits = [
                Math.floor(hours / 10),
                hours % 10,
                Math.floor(minutes / 10),
                minutes % 10
            ];
        
            timeDigits.forEach((digit, index) => {
                const digitSpan = document.createElement('span');
                digitSpan.className = 'digit';
                // **Use individual digit color or fall back to global color**
                digitSpan.style.color = digitColors[index] || color;
                digitSpan.textContent = digit;
                digitSpan.addEventListener('click', () => {
                    selectedElement = { type: 'digit', index: index };
                    digitColorPicker.color.hexString = digitColors[index] || color;
                    openDigitColorPickerModal();
                });
                digitDisplay.appendChild(digitSpan);
        
                // Add colon at appropriate position
                if (index === 1) {
                    const colonSpan = document.createElement('span');
                    colonSpan.className = 'digit colon';
                    // **Use individual colon color or fall back to global color**
                    colonSpan.style.color = colonColor || color;
                    colonSpan.textContent = ':';
                    colonSpan.addEventListener('click', () => {
                        selectedElement = { type: 'colon', index: 0 };
                        digitColorPicker.color.hexString = colonColor || color;
                        openDigitColorPickerModal();
                    });
                    digitDisplay.appendChild(colonSpan);
                }
            });
        }
        
        
        // Automatically refresh the time every 20 seconds
        setInterval(fetchTime, 20000);
        // Load Time Zone Settings
        function loadTimeZoneSettings() {
            // Populate the time zone select element
            const timezoneSelect = document.getElementById('timezoneSelect');
            // Time zones with POSIX tzCode
            const timezones = [
                // Time zones data...
                {name:"UTC12:00", tzCode:"UTC+12", location:"Baker Island"},
        
                // UTC11:00
                {name:"UTC11:00", tzCode:"UTC+11", location:"American Samoa"},
        
                // UTC10:00 (Hawaii Standard Time, no DST)
                {name:"Hawaii Standard Time", tzCode:"HST10", location:"Hawaii"},
        
                // UTC09:00 (Alaska Standard Time)
                {name:"Alaska Standard Time", tzCode:"AKST9AKDT,M3.2.0,M11.1.0", location:"Alaska"},
        
                // UTC08:00 (Pacific Time)
                {name:"Pacific Time (US & Canada)", tzCode:"PST8PDT,M3.2.0,M11.1.0", location:"Los Angeles, Vancouver"},
        
                // UTC07:00 (Mountain Time)
                {name:"Mountain Time (US & Canada)", tzCode:"MST7MDT,M3.2.0,M11.1.0", location:"Denver, Edmonton"},
        
                // UTC06:00 (Central Time)
                {name:"Central Time (US & Canada)", tzCode:"CST6CDT,M3.2.0,M11.1.0", location:"Chicago, Mexico City"},
        
                // UTC05:00 (Eastern Time)
                {name:"Eastern Time (US & Canada)", tzCode:"EST5EDT,M3.2.0,M11.1.0", location:"New York, Toronto"},
        
                // UTC04:00 (Atlantic Time)
                {name:"Atlantic Time (Canada)", tzCode:"AST4ADT,M3.2.0,M11.1.0", location:"Halifax, Puerto Rico"},
        
                // UTC03:00 (Argentina, Greenland)
                {name:"UTC03:00", tzCode:"ART3", location:"Buenos Aires, Greenland"},
        
                // UTC02:00 (South Georgia)
                {name:"UTC02:00", tzCode:"UTC+2", location:"South Georgia and the South Sandwich Islands"},
        
                // UTC01:00 (Azores)
                {name:"Azores Standard Time", tzCode:"AZOT1AZOST,M3.5.0/0,M10.5.0/1", location:"Azores, Cape Verde"},
        
                // UTC+00:00 (GMT)
                {name:"Greenwich Mean Time", tzCode:"GMT0BST,M3.5.0/1,M10.5.0/2", location:"London, Dublin, Lisbon"},
        
                // UTC+01:00 (Central European Time)
                {name:"Central European Time", tzCode:"CET-1CEST,M3.5.0,M10.5.0/3", location:"Berlin, Paris, Madrid"},
        
                // UTC+02:00 (Eastern European Time)
                {name:"Eastern European Time", tzCode:"EET-2EEST,M3.5.0/3,M10.5.0/4", location:"Athens, Cairo, Johannesburg"},
        
                // UTC+03:00 (Moscow Time)
                {name:"Moscow Standard Time", tzCode:"MSK-3", location:"Moscow, Istanbul, Riyadh"},
        
                // UTC+04:00
                {name:"UTC+04:00", tzCode:"GST-4", location:"Dubai, Baku, Samara"},
        
                // UTC+05:00
                {name:"UTC+05:00", tzCode:"PKT-5", location:"Karachi, Islamabad, Tashkent"},
        
                // UTC+06:00
                {name:"UTC+06:00", tzCode:"BST-6", location:"Dhaka, Almaty"},
        
                // UTC+07:00
                {name:"UTC+07:00", tzCode:"ICT-7", location:"Bangkok, Jakarta, Hanoi"},
        
                // UTC+08:00
                {name:"UTC+08:00", tzCode:"CST-8", location:"Beijing, Singapore, Perth"},
        
                // UTC+09:00
                {name:"Japan Standard Time", tzCode:"JST-9", location:"Tokyo, Seoul, Yakutsk"},
        
                // UTC+10:00
                {name:"Australian Eastern Time", tzCode:"AEST-10AEDT,M10.1.0,M4.1.0/3", location:"Sydney, Guam, Vladivostok"},
        
                // UTC+11:00
                {name:"UTC+11:00", tzCode:"SBT-11", location:"Solomon Islands, New Caledonia"},
        
                // UTC+12:00
                {name:"New Zealand Standard Time", tzCode:"NZST-12NZDT,M9.5.0,M4.1.0/3", location:"Auckland, Fiji, Kamchatka"},
        
                // UTC+13:00
                {name:"UTC+13:00", tzCode:"TOT-13", location:"Samoa, Tonga"},
        
                // UTC+14:00
                {name:"UTC+14:00", tzCode:"LINT-14", location:"Kiritimati Island"}
            ];
            timezoneSelect.innerHTML = '';
            timezones.forEach(tz => {
                const option = document.createElement('option');
                option.value = tz.tzCode;
                option.textContent = `${tz.name} - ${tz.location}`;
                if (tz.tzCode === timeZoneString) {
                    option.selected = true;
                }
                timezoneSelect.appendChild(option);
            });
        }
        // Save Time Zone Settings
        document.getElementById('saveTimezoneButton').addEventListener('click', function() {
            const selectedTimeZoneString = document.getElementById('timezoneSelect').value;
            timeZoneString = selectedTimeZoneString;
            // Send the time zone settings to the server
            fetch('/setTimeZone', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ timeZoneString: timeZoneString })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Time zone settings saved on server:', data);
                alert('Time zone settings saved.');
            })
            .catch(error => {
                console.error('Error saving time zone settings:', error);
            });
        });
        
        // Load Wi-Fi Settings
        function loadWiFiSettings() {
            // Fetch Wi-Fi settings from the server
            fetch('/getWiFiSettings')
                .then(response => response.json())
                .then(data => {
                    enableWiFiOff = data.enableWiFiOff || false;
                    wifiOffStartTime = data.wifiOffStartTime || '';
                    wifiOffEndTime = data.wifiOffEndTime || '';
                    document.getElementById('wifiOffCheckbox').checked = enableWiFiOff;
                    document.getElementById('wifiOffStart').value = wifiOffStartTime;
                    document.getElementById('wifiOffEnd').value = wifiOffEndTime;
                })
                .catch(error => {
                    console.error('Error fetching Wi-Fi settings:', error);
                });
            // Get the device IP address
            fetch('/getIPAddress')
                .then(response => response.json())
                .then(data => {
                    deviceIPAddress = data.ip || 'Unavailable';
                    document.getElementById('deviceIPAddress').textContent = deviceIPAddress;
                })
                .catch(error => {
                    console.error('Error fetching IP address:', error);
                    document.getElementById('deviceIPAddress').textContent = 'Unavailable';
                });
        }
        // Save Wi-Fi Settings
        document.getElementById('saveWiFiSettingsButton').addEventListener('click', function() {
            const ssid = document.getElementById('ssidInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            enableWiFiOff = document.getElementById('wifiOffCheckbox').checked;
            wifiOffStartTime = document.getElementById('wifiOffStart').value;
            wifiOffEndTime = document.getElementById('wifiOffEnd').value;
        
            // Build the data object to send
            let dataToSend = {
                enableWiFiOff: enableWiFiOff,
                wifiOffStartTime: wifiOffStartTime,
                wifiOffEndTime: wifiOffEndTime
            };
        
            // Only include ssid and password if they are provided
            if (ssid) {
                dataToSend.ssid = ssid;
            }
            if (password) {
                dataToSend.password = password;
            }
        
            // Send Wi-Fi settings to the server
            fetch('/setWiFiSettings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Wi-Fi settings saved on server:', data);
                alert('Wi-Fi settings saved. The device may restart to apply changes.');
            })
            .catch(error => {
                console.error('Error saving Wi-Fi settings:', error);
            });
        });
        
    </script>
</body>
</html>

